# TRON èƒ½é‡ç§Ÿèµå¹³å° - æŠ€æœ¯è®¾è®¡æ–¹æ¡ˆ

**ç‰ˆæœ¬**: v1.0  
**æ—¥æœŸ**: 2026å¹´1æœˆ4æ—¥  
**æ¶æ„å¸ˆ**: Tech Lead  

---

## 1. æŠ€æœ¯é€‰å‹

### 1.1 åç«¯æŠ€æœ¯æ ˆ

```
è¿è¡Œæ—¶: Node.js 20+ LTS
æ¡†æ¶: Express.js / Fastify
è¯­è¨€: TypeScript 5+
åŒºå—é“¾SDK: TronWeb 5.x
```

**é€‰å‹ç†ç”±**ï¼š
- Node.js å¼‚æ­¥éé˜»å¡ç‰¹æ€§é€‚åˆé«˜å¹¶å‘åœºæ™¯
- TypeScript æä¾›ç±»å‹å®‰å…¨ï¼Œå‡å°‘è¿è¡Œæ—¶é”™è¯¯
- TronWeb æ˜¯ TRON å®˜æ–¹æ¨èçš„ JavaScript SDKï¼Œæ”¯æŒè´¨æŠ¼ã€å§”æ‰˜ç­‰å…¨éƒ¨æ“ä½œ
- ç¤¾åŒºæ´»è·ƒï¼Œç”Ÿæ€å®Œå–„

### 1.2 æ•°æ®å­˜å‚¨

```
å…³ç³»å‹æ•°æ®åº“: MySQL 8.0+
  - ä¸»æ•°æ®å­˜å‚¨ï¼ˆç”¨æˆ·ã€è®¢å•ã€é…ç½®ï¼‰
  - JSON å­—æ®µæ”¯æŒçµæ´»æ•°æ®ç»“æ„
  - äº‹åŠ¡æ”¯æŒï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§
  - ä¸»ä»å¤åˆ¶ã€è¯»å†™åˆ†ç¦»
  
ç¼“å­˜: Redis 7+
  - ä¼šè¯ç®¡ç†
  - çƒ­ç‚¹æ•°æ®ç¼“å­˜
  - åˆ†å¸ƒå¼é”
  - æ¶ˆæ¯é˜Ÿåˆ—
  
å¯¹è±¡å­˜å‚¨: MinIO / AWS S3
  - æ—¥å¿—æ–‡ä»¶
  - å¯¼å‡ºæ•°æ®
```

### 1.3 æ¶ˆæ¯é˜Ÿåˆ—

```
é˜Ÿåˆ—: Redis + BullMQ
  - è®¢å•å¤„ç†é˜Ÿåˆ—
  - é€šçŸ¥å‘é€é˜Ÿåˆ—
  - ç›‘æ§ä»»åŠ¡é˜Ÿåˆ—
  - å®šæ—¶ä»»åŠ¡
```

### 1.4 TG æœºå™¨äºº

```
æ¡†æ¶: node-telegram-bot-api / telegraf
è¯­è¨€: TypeScript
ä¼šè¯ç®¡ç†: Redis Sessions
```

### 1.5 DevOps

```
å®¹å™¨åŒ–: Docker + Docker Compose
ç¼–æ’: Kubernetes (ç”Ÿäº§ç¯å¢ƒ)
CI/CD: GitHub Actions
ç›‘æ§: Prometheus + Grafana
æ—¥å¿—: Winston + Loki
è¿½è¸ª: OpenTelemetry
```

---

## 2. ç³»ç»Ÿæ¶æ„è¯¦ç»†è®¾è®¡

### 2.1 æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å®¢æˆ·ç«¯å±‚                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚TGæœºå™¨äºº   â”‚  â”‚API Client â”‚  â”‚Webç®¡ç†å° â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ HTTPS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç½‘å…³å±‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚    Nginx / API Gateway                           â”‚  â”‚
â”‚  â”‚    - SSL ç»ˆæ­¢                                     â”‚  â”‚
â”‚  â”‚    - è´Ÿè½½å‡è¡¡                                     â”‚  â”‚
â”‚  â”‚    - é™æµç†”æ–­                                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¸šåŠ¡æœåŠ¡å±‚                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ API Service â”‚  â”‚  TG Bot     â”‚  â”‚Admin Serviceâ”‚    â”‚
â”‚  â”‚             â”‚  â”‚  Service    â”‚  â”‚             â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚            æ ¸å¿ƒä¸šåŠ¡æ¨¡å—                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚   â”‚
â”‚  â”‚  â”‚è®¢å•æ¨¡å—   â”‚ â”‚ç”¨æˆ·æ¨¡å—   â”‚ â”‚é€šçŸ¥æ¨¡å—   â”‚       â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚   â”‚
â”‚  â”‚  â”‚ä»·æ ¼æ¨¡å—   â”‚ â”‚ç›‘æ§æ¨¡å—   â”‚ â”‚ç»Ÿè®¡æ¨¡å—   â”‚       â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ•°æ®è®¿é—®å±‚                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ORM Layer (TypeORM / Prisma)                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   å­˜å‚¨ & å¤–éƒ¨æœåŠ¡                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚PostgreSQLâ”‚  â”‚  Redis   â”‚  â”‚  Bull MQ â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚TRON Node â”‚  â”‚ä¾›åº”å•†API  â”‚  â”‚TG Bot APIâ”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 ç›®å½•ç»“æ„

```
tron-energy/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ api/                    # API æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ controllers/        # æ§åˆ¶å™¨
â”‚   â”‚   â”œâ”€â”€ middlewares/        # ä¸­é—´ä»¶
â”‚   â”‚   â”œâ”€â”€ routes/             # è·¯ç”±
â”‚   â”‚   â””â”€â”€ validators/         # å‚æ•°éªŒè¯
â”‚   â”‚
â”‚   â”œâ”€â”€ telegram/               # TG æœºå™¨äºº
â”‚   â”‚   â”œâ”€â”€ bot.ts              # æœºå™¨äººå…¥å£
â”‚   â”‚   â”œâ”€â”€ commands/           # å‘½ä»¤å¤„ç†
â”‚   â”‚   â”œâ”€â”€ scenes/             # ä¼šè¯åœºæ™¯
â”‚   â”‚   â”œâ”€â”€ keyboards/          # é”®ç›˜å¸ƒå±€
â”‚   â”‚   â””â”€â”€ handlers/           # æ¶ˆæ¯å¤„ç†
â”‚   â”‚
â”‚   â”œâ”€â”€ services/               # ä¸šåŠ¡æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ order.service.ts    # è®¢å•æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ user.service.ts     # ç”¨æˆ·æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ energy.service.ts   # èƒ½é‡æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ price.service.ts    # ä»·æ ¼æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ resource-pool.service.ts # TRX èµ„æºæ± ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ monitor.service.ts  # ç›‘æ§æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ notification.service.ts # é€šçŸ¥æœåŠ¡
â”‚   â”‚   â””â”€â”€ tron.service.ts     # TRON é“¾äº¤äº’æœåŠ¡
â”‚   â”‚
â”‚   â”œâ”€â”€ workers/                # åå°ä»»åŠ¡
â”‚   â”‚   â”œâ”€â”€ order-processor.ts  # è®¢å•å¤„ç†
â”‚   â”‚   â”œâ”€â”€ resource-manager.ts # èµ„æºè°ƒåº¦
â”‚   â”‚   â”œâ”€â”€ monitor-worker.ts   # ç›‘æ§ä»»åŠ¡
â”‚   â”‚   â”œâ”€â”€ notification-worker.ts # é€šçŸ¥å‘é€
â”‚   â”‚   â””â”€â”€ daily-report.ts     # æ—¥æŠ¥ç”Ÿæˆ
â”‚   â”‚
â”‚   â”œâ”€â”€ models/                 # æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ user.model.ts
â”‚   â”‚   â”œâ”€â”€ order.model.ts
â”‚   â”‚   â”œâ”€â”€ resource-pool.model.ts
â”‚   â”‚   â”œâ”€â”€ auto-rent-rule.model.ts
â”‚   â”‚   â””â”€â”€ monitor-address.model.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ blockchain/             # åŒºå—é“¾äº¤äº’å±‚
â”‚   â”‚   â”œâ”€â”€ tronweb.client.ts   # TronWeb å®¢æˆ·ç«¯
â”‚   â”‚   â”œâ”€â”€ delegate.handler.ts # å§”æ‰˜å¤„ç†
â”‚   â”‚   â”œâ”€â”€ freeze.handler.ts   # è´¨æŠ¼å¤„ç†
â”‚   â”‚   â””â”€â”€ account.handler.ts  # è´¦æˆ·æŸ¥è¯¢
â”‚   â”‚
â”‚   â”œâ”€â”€ utils/                  # å·¥å…·å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ crypto.ts           # åŠ å¯†è§£å¯†
â”‚   â”‚   â”œâ”€â”€ validator.ts        # éªŒè¯å·¥å…·
â”‚   â”‚   â””â”€â”€ logger.ts           # æ—¥å¿—å·¥å…·
â”‚   â”‚
â”‚   â”œâ”€â”€ config/                 # é…ç½®æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ database.ts
â”‚   â”‚   â”œâ”€â”€ redis.ts
â”‚   â”‚   â”œâ”€â”€ telegram.ts
â”‚   â”‚   â””â”€â”€ tron.ts
â”‚   â”‚
â”‚   â””â”€â”€ types/                  # ç±»å‹å®šä¹‰
â”‚       â”œâ”€â”€ api.types.ts
â”‚       â”œâ”€â”€ order.types.ts
â”‚       â””â”€â”€ telegram.types.ts
â”‚
â”œâ”€â”€ tests/                      # æµ‹è¯•æ–‡ä»¶
â”‚   â”œâ”€â”€ unit/
â”‚   â”œâ”€â”€ integration/
â”‚   â””â”€â”€ e2e/
â”‚
â”œâ”€â”€ docs/                       # æ–‡æ¡£
â”‚   â”œâ”€â”€ PRD-äº§å“éœ€æ±‚æ–‡æ¡£.md
â”‚   â”œâ”€â”€ æŠ€æœ¯è®¾è®¡æ–¹æ¡ˆ.md
â”‚   â””â”€â”€ APIæ–‡æ¡£.md
â”‚
â”œâ”€â”€ scripts/                    # è„šæœ¬
â”‚   â”œâ”€â”€ migrate.ts
â”‚   â”œâ”€â”€ seed.ts
â”‚   â””â”€â”€ deploy.sh
â”‚
â”œâ”€â”€ docker/                     # Docker é…ç½®
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”œâ”€â”€ docker-compose.yml
â”‚   â””â”€â”€ docker-compose.prod.yml
â”‚
â”œâ”€â”€ .github/                    # GitHub é…ç½®
â”‚   â””â”€â”€ workflows/
â”‚       â”œâ”€â”€ ci.yml
â”‚       â””â”€â”€ deploy.yml
â”‚
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ .env.example
â””â”€â”€ README.md
```

---

## 3. æ ¸å¿ƒæ¨¡å—è¯¦ç»†è®¾è®¡

### 3.1 è®¢å•æœåŠ¡ (Order Service)

**èŒè´£**ï¼š
- è®¢å•åˆ›å»ºã€æŸ¥è¯¢ã€æ›´æ–°
- è®¢å•çŠ¶æ€æµè½¬
- è®¢å•é€€æ¬¾å¤„ç†

**æ ¸å¿ƒä»£ç ç»“æ„**ï¼š

```typescript
// src/services/order.service.ts

export class OrderService {
  /**
   * åˆ›å»ºè®¢å•
   */
  async createOrder(params: CreateOrderParams): Promise<Order> {
    // 1. éªŒè¯å‚æ•°
    this.validateOrderParams(params);
    
    // 2. æ£€æŸ¥ç”¨æˆ·ä½™é¢
    await this.checkUserBalance(params.userId, params.price);
    
    // 3. é”å®šç”¨æˆ·ä½™é¢
    await this.lockUserBalance(params.userId, params.price);
    
    // 4. åˆ›å»ºè®¢å•è®°å½•
    const order = await this.createOrderRecord(params);
    
    // 5. æ¨é€åˆ°è®¢å•å¤„ç†é˜Ÿåˆ—
    await this.queueOrder(order);
    
    return order;
  }
  
  /**
   * å¤„ç†è®¢å•
   */
  async processOrder(orderId: string): Promise<void> {
    const order = await this.getOrder(orderId);
    
    try {
      // 1. æ›´æ–°çŠ¶æ€ä¸ºå¤„ç†ä¸­
      await this.updateOrderStatus(orderId, OrderStatus.PROCESSING);
      
      // 2. è°ƒç”¨ä¾›åº”å•†API
      const result = await this.providerManager.delegateEnergy({
        receiverAddress: order.receiverAddress,
        energyAmount: order.energyAmount,
        durationHours: order.durationHours
      });
      
      // 3. ç­‰å¾…é“¾ä¸Šç¡®è®¤
      await this.waitForConfirmation(result.txHash);
      
      // 4. æ›´æ–°è®¢å•ä¸ºå·²å®Œæˆ
      await this.completeOrder(orderId, result.txHash);
      
      // 5. å‘é€é€šçŸ¥
      await this.notificationService.sendOrderCompleted(order);
      
    } catch (error) {
      // å¤„ç†å¤±è´¥ï¼Œé€€æ¬¾
      await this.refundOrder(orderId, error);
      throw error;
    }
  }
  
  /**
   * é€€æ¬¾
   */
  async refundOrder(orderId: string, reason: string): Promise<void> {
    const order = await this.getOrder(orderId);
    
    // 1. é‡Šæ”¾é”å®šä½™é¢
    await this.unlockUserBalance(order.userId, order.price);
    
    // 2. æ›´æ–°è®¢å•çŠ¶æ€
    await this.updateOrderStatus(orderId, OrderStatus.REFUNDED);
    
    // 3. è®°å½•é€€æ¬¾æ—¥å¿—
    await this.logRefund(orderId, reason);
    
    // 4. å‘é€é€šçŸ¥
    await this.notificationService.sendOrderRefunded(order, reason);
  }
}
```

### 3.2 èƒ½é‡æœåŠ¡ (Energy Service)

**èŒè´£**ï¼š
- åœ°å€èƒ½é‡æŸ¥è¯¢
- ä»·æ ¼è®¡ç®—
- ä¾›åº”å•†ç®¡ç†

```typescript
// src/services/energy.service.ts

export class EnergyService {
  /**
   * æŸ¥è¯¢åœ°å€èƒ½é‡
   */
  async getAddressEnergy(address: string): Promise<EnergyInfo> {
    // ä¼˜å…ˆä»ç¼“å­˜è·å–
    const cached = await this.cache.get(`energy:${address}`);
    if (cached) return JSON.parse(cached);
    
    // ä»é“¾ä¸ŠæŸ¥è¯¢
    const account = await this.tronWeb.trx.getAccount(address);
    
    const energyInfo = {
      address,
      energyAvailable: account.account_resource?.energy_available || 0,
      energyUsed: account.account_resource?.energy_used || 0,
      energyLimit: account.account_resource?.energy_limit || 0,
      bandwidthAvailable: account.free_net_usage || 0,
      trxBalance: this.tronWeb.fromSun(account.balance || 0)
    };
    
    // ç¼“å­˜5åˆ†é’Ÿ
    await this.cache.setex(`energy:${address}`, 300, JSON.stringify(energyInfo));
    
    return energyInfo;
  }
  
  /**
   * è®¡ç®—ä»·æ ¼
   */
  async calculatePrice(
    energyAmount: number,
    durationHours: number
  ): Promise<PriceInfo> {
    // 1. è·å–å¸‚åœºåŸºå‡†ä»·æ ¼
    const basePrice = await this.getMarketPrice();
    
    // 2. è®¡ç®—åŸºç¡€è´¹ç”¨
    const baseCost = energyAmount * basePrice * this.getDurationMultiplier(durationHours);
    
    // 3. åº”ç”¨æŠ˜æ‰£
    const discount = this.calculateDiscount(energyAmount);
    
    // 4. åŠ ä¸Šå¹³å°æ‰‹ç»­è´¹
    const fee = baseCost * this.config.platformFeeRate;
    
    const finalPrice = baseCost * (1 - discount) + fee;
    
    return {
      energyAmount,
      durationHours,
      price: finalPrice,
      unitPrice: finalPrice / energyAmount,
      marketPrice: baseCost,
      discountRate: discount,
      available: true
    };
  }
  
  /**
   * è·å–å¸‚åœºä»·æ ¼
   */
  private async getMarketPrice(): Promise<number> {
    // ä»å¤šä¸ªä¾›åº”å•†è·å–ä»·æ ¼ï¼Œå–å¹³å‡å€¼æˆ–æœ€ä¼˜ä»·æ ¼
    const prices = await Promise.all(
      this.providers.map(p => p.getPrice())
    );
    
    return Math.min(...prices); // å–æœ€ä½ä»·
  }
}
```

### 3.3 TRX èµ„æºæ± ç®¡ç†æœåŠ¡ (Resource Pool Service)

**èŒè´£**ï¼š
- å¹³å° TRX èµ„äº§ç®¡ç†
- è´¨æŠ¼/è§£è´¨æŠ¼è°ƒåº¦
- èƒ½é‡æ± çŠ¶æ€ç›‘æ§
- èµ„æºåˆ©ç”¨ç‡ä¼˜åŒ–

```typescript
// src/services/resource-pool.service.ts

export class ResourcePoolService {
  private tronService: TronService;
  
  /**
   * å§”æ‰˜èƒ½é‡ç»™ç”¨æˆ·ï¼ˆæ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼‰
   */
  async delegateEnergyToUser(params: DelegateParams): Promise<DelegateResult> {
    const { receiverAddress, energyAmount, durationHours } = params;
    
    // 1. æ£€æŸ¥èµ„æºæ± çŠ¶æ€
    await this.checkPoolAvailability(energyAmount);
    
    // 2. è®¡ç®—éœ€è¦è´¨æŠ¼çš„ TRX æ•°é‡
    const trxAmount = await this.calculateRequiredTRX(energyAmount, durationHours);
    
    // 3. ä»çƒ­é’±åŒ…è´¨æŠ¼ TRX è·å–èƒ½é‡
    const freezeResult = await this.tronService.freezeBalanceV2({
      amount: trxAmount,
      resource: 'ENERGY'
    });
    
    // 4. å§”æ‰˜èƒ½é‡ç»™ç”¨æˆ·åœ°å€
    const delegateResult = await this.tronService.delegateResource({
      receiverAddress,
      balance: trxAmount,
      resource: 'ENERGY',
      lock: true,
      lockPeriod: durationHours * 3600 // è½¬æ¢ä¸ºç§’
    });
    
    // 5. è®°å½•å§”æ‰˜ä¿¡æ¯åˆ°æ•°æ®åº“
    await this.recordDelegation({
      orderId: params.orderId,
      receiverAddress,
      energyAmount,
      trxAmount,
      durationHours,
      txHash: delegateResult.txid,
      expireTime: new Date(Date.now() + durationHours * 3600000)
    });
    
    return {
      success: true,
      txHash: delegateResult.txid,
      energyAmount,
      expireTime: new Date(Date.now() + durationHours * 3600000)
    };
  }
  
  /**
   * æ£€æŸ¥èµ„æºæ± å¯ç”¨æ€§
   */
  private async checkPoolAvailability(requiredEnergy: number): Promise<void> {
    const poolStatus = await this.getPoolStatus();
    
    if (poolStatus.availableTRX < this.calculateRequiredTRX(requiredEnergy, 1)) {
      throw new Error('èµ„æºæ±  TRX ä½™é¢ä¸è¶³');
    }
    
    if (poolStatus.utilizationRate > 0.9) {
      this.logger.warn('èµ„æºæ± åˆ©ç”¨ç‡è¿‡é«˜ï¼Œå»ºè®®è¡¥å…… TRX');
    }
  }
  
  /**
   * è®¡ç®—æ‰€éœ€ TRX æ•°é‡
   */
  private async calculateRequiredTRX(
    energyAmount: number,
    durationHours: number
  ): Promise<number> {
    // TRON ç½‘ç»œä¸­ï¼Œ1 TRX è´¨æŠ¼çº¦å¯è·å¾— ~1200-1500 èƒ½é‡ï¼ˆæ ¹æ®ç½‘ç»œçŠ¶æ€åŠ¨æ€å˜åŒ–ï¼‰
    // è¿™é‡Œä½¿ç”¨ä¿å®ˆä¼°è®¡ 1 TRX = 1200 èƒ½é‡
    const energyPerTRX = await this.getEnergyPerTRX();
    return Math.ceil(energyAmount / energyPerTRX);
  }
  
  /**
   * è·å–èµ„æºæ± çŠ¶æ€
   */
  async getPoolStatus(): Promise<PoolStatus> {
    const hotWalletAddress = config.tron.hotWalletAddress;
    const account = await this.tronService.getAccount(hotWalletAddress);
    
    // æŸ¥è¯¢æ‰€æœ‰å§”æ‰˜è®°å½•
    const activeDelegations = await this.getActiveDelegations();
    
    const totalTRX = this.tronService.fromSun(account.balance);
    const frozenTRX = activeDelegations.reduce((sum, d) => sum + d.trxAmount, 0);
    const availableTRX = totalTRX - frozenTRX;
    
    return {
      totalTRX,
      frozenTRX,
      availableTRX,
      activeOrders: activeDelegations.length,
      utilizationRate: frozenTRX / totalTRX,
      totalEnergy: account.account_resource?.energy_limit || 0
    };
  }
  
  /**
   * è‡ªåŠ¨å›æ”¶åˆ°æœŸèµ„æºï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰
   */
  async reclaimExpiredResources(): Promise<void> {
    const expiredDelegations = await this.getExpiredDelegations();
    
    this.logger.info(`å‘ç° ${expiredDelegations.length} ä¸ªåˆ°æœŸå§”æ‰˜ï¼Œå¼€å§‹å›æ”¶`);
    
    for (const delegation of expiredDelegations) {
      try {
        // TRON å§”æ‰˜åˆ°æœŸåä¼šè‡ªåŠ¨è§£é™¤ï¼Œä¸éœ€è¦æ‰‹åŠ¨æ“ä½œ
        // åªéœ€è¦æ›´æ–°æ•°æ®åº“çŠ¶æ€
        await this.updateDelegationStatus(delegation.id, 'expired');
        
        this.logger.info(`å§”æ‰˜ ${delegation.id} å·²åˆ°æœŸï¼Œèµ„æºå·²å›æ”¶`);
      } catch (error) {
        this.logger.error(`å›æ”¶å§”æ‰˜ ${delegation.id} å¤±è´¥`, error);
      }
    }
  }
  
  /**
   * èµ„æºæ± ä¼˜åŒ–å»ºè®®
   */
  async getOptimizationSuggestions(): Promise<string[]> {
    const status = await this.getPoolStatus();
    const suggestions: string[] = [];
    
    if (status.utilizationRate > 0.9) {
      suggestions.push('èµ„æºåˆ©ç”¨ç‡è¿‡é«˜ï¼Œå»ºè®®å¢åŠ  TRX å‚¨å¤‡');
    }
    
    if (status.availableTRX < 10000) {
      suggestions.push('å¯ç”¨ TRX ä¸è¶³ 10000ï¼Œå»ºè®®åŠæ—¶è¡¥å……');
    }
    
    return suggestions;
  }
}
```

### 3.4 TRON é“¾äº¤äº’æœåŠ¡ (Tron Service)

**èŒè´£**ï¼š
- TronWeb å°è£…
- é“¾ä¸Šæ“ä½œï¼ˆè´¨æŠ¼ã€å§”æ‰˜ã€æŸ¥è¯¢ï¼‰
- äº¤æ˜“ç¡®è®¤å’Œé”™è¯¯å¤„ç†

```typescript
// src/services/tron.service.ts

export class TronService {
  private tronWeb: TronWeb;
  
  constructor() {
    this.tronWeb = new TronWeb({
      fullHost: config.tron.fullHost,
      privateKey: config.tron.privateKey
    });
  }
  
  /**
   * è´¨æŠ¼ TRX è·å–èƒ½é‡ (Stake 2.0)
   */
  async freezeBalanceV2(params: {
    amount: number;
    resource: 'ENERGY' | 'BANDWIDTH';
  }): Promise<any> {
    try {
      const { amount, resource } = params;
      
      // ä½¿ç”¨ Stake 2.0 API
      const transaction = await this.tronWeb.transactionBuilder.freezeBalanceV2(
        this.tronWeb.toSun(amount),
        resource
      );
      
      const signedTx = await this.tronWeb.trx.sign(transaction);
      const result = await this.tronWeb.trx.sendRawTransaction(signedTx);
      
      // ç­‰å¾…äº¤æ˜“ç¡®è®¤
      await this.waitForTransaction(result.txid);
      
      return result;
    } catch (error) {
      this.logger.error('è´¨æŠ¼ TRX å¤±è´¥', error);
      throw new Error(`è´¨æŠ¼å¤±è´¥: ${error.message}`);
    }
  }
  
  /**
   * å§”æ‰˜èµ„æºç»™å…¶ä»–åœ°å€
   */
  async delegateResource(params: {
    receiverAddress: string;
    balance: number;
    resource: 'ENERGY' | 'BANDWIDTH';
    lock: boolean;
    lockPeriod?: number; // ç§’
  }): Promise<any> {
    try {
      const { receiverAddress, balance, resource, lock, lockPeriod } = params;
      
      const transaction = await this.tronWeb.transactionBuilder.delegateResource(
        this.tronWeb.toSun(balance),
        receiverAddress,
        resource,
        this.tronWeb.defaultAddress.base58,
        lock,
        lockPeriod
      );
      
      const signedTx = await this.tronWeb.trx.sign(transaction);
      const result = await this.tronWeb.trx.sendRawTransaction(signedTx);
      
      // ç­‰å¾…äº¤æ˜“ç¡®è®¤
      await this.waitForTransaction(result.txid);
      
      return result;
    } catch (error) {
      this.logger.error('å§”æ‰˜èµ„æºå¤±è´¥', error);
      throw new Error(`å§”æ‰˜å¤±è´¥: ${error.message}`);
    }
  }
  
  /**
   * è§£è´¨æŠ¼ TRX
   */
  async unfreezeBalanceV2(resource: 'ENERGY' | 'BANDWIDTH'): Promise<any> {
    try {
      const transaction = await this.tronWeb.transactionBuilder.unfreezeBalanceV2(
        resource
      );
      
      const signedTx = await this.tronWeb.trx.sign(transaction);
      const result = await this.tronWeb.trx.sendRawTransaction(signedTx);
      
      await this.waitForTransaction(result.txid);
      
      return result;
    } catch (error) {
      this.logger.error('è§£è´¨æŠ¼å¤±è´¥', error);
      throw new Error(`è§£è´¨æŠ¼å¤±è´¥: ${error.message}`);
    }
  }
  
  /**
   * æŸ¥è¯¢è´¦æˆ·ä¿¡æ¯
   */
  async getAccount(address: string): Promise<any> {
    try {
      return await this.tronWeb.trx.getAccount(address);
    } catch (error) {
      this.logger.error(`æŸ¥è¯¢è´¦æˆ· ${address} å¤±è´¥`, error);
      throw error;
    }
  }
  
  /**
   * æŸ¥è¯¢è´¦æˆ·èµ„æº
   */
  async getAccountResources(address: string): Promise<any> {
    try {
      return await this.tronWeb.trx.getAccountResources(address);
    } catch (error) {
      this.logger.error(`æŸ¥è¯¢è´¦æˆ·èµ„æº ${address} å¤±è´¥`, error);
      throw error;
    }
  }
  
  /**
   * ç­‰å¾…äº¤æ˜“ç¡®è®¤
   */
  private async waitForTransaction(
    txid: string,
    timeout: number = 60000
  ): Promise<void> {
    const startTime = Date.now();
    
    while (Date.now() - startTime < timeout) {
      try {
        const txInfo = await this.tronWeb.trx.getTransactionInfo(txid);
        
        if (txInfo && txInfo.id) {
          if (txInfo.receipt && txInfo.receipt.result === 'SUCCESS') {
            return; // äº¤æ˜“æˆåŠŸ
          } else if (txInfo.receipt && txInfo.receipt.result === 'FAILED') {
            throw new Error('äº¤æ˜“å¤±è´¥');
          }
        }
      } catch (error) {
        // äº¤æ˜“å°šæœªä¸Šé“¾ï¼Œç»§ç»­ç­‰å¾…
      }
      
      await new Promise(resolve => setTimeout(resolve, 3000)); // 3ç§’åé‡è¯•
    }
    
    throw new Error('äº¤æ˜“ç¡®è®¤è¶…æ—¶');
  }
  
  /**
   * ä» Sun å•ä½è½¬æ¢ä¸º TRX
   */
  fromSun(sun: number): number {
    return this.tronWeb.fromSun(sun);
  }
  
  /**
   * ä» TRX è½¬æ¢ä¸º Sun å•ä½
   */
  toSun(trx: number): number {
    return this.tronWeb.toSun(trx);
  }
}
```

### 3.5 ä¾›åº”å•†ç®¡ç† (å·²ç§»é™¤)

**è¯´æ˜**ï¼šç”±äºå¹³å°ç›´æ¥è´¨æŠ¼ TRX å‡ºç§Ÿèƒ½é‡ï¼Œä¸å†éœ€è¦å¯¹æ¥ç¬¬ä¸‰æ–¹ä¾›åº”å•†ã€‚åŸæœ‰çš„ ProviderManager æ¨¡å—å¯ä»¥ç§»é™¤æˆ–ä¿ç•™ä½œä¸ºæœªæ¥æ‰©å±•å¤‡ç”¨ã€‚

### 3.6 è‡ªåŠ¨ç§ŸèµæœåŠ¡ (Auto Rent Service)
  private providers: EnergyProvider[] = [];
  
  /**
   * å§”æ‰˜èƒ½é‡ï¼ˆæ™ºèƒ½é€‰æ‹©ä¾›åº”å•†ï¼‰
   */
  async delegateEnergy(params: DelegateParams): Promise<DelegateResult> {
    // 1. è·å–å¯ç”¨ä¾›åº”å•†åˆ—è¡¨
    const availableProviders = await this.getAvailableProviders();
    
    if (availableProviders.length === 0) {
      throw new Error('æ²¡æœ‰å¯ç”¨çš„ä¾›åº”å•†');
    }
    
    // 2. æŒ‰ä¼˜å…ˆçº§æ’åºï¼ˆä»·æ ¼ã€æˆåŠŸç‡ã€å»¶è¿Ÿï¼‰
    const sortedProviders = this.sortProviders(availableProviders);
    
    // 3. å°è¯•è°ƒç”¨ä¾›åº”å•†
    for (const provider of sortedProviders) {
      try {
        const result = await provider.delegate(params);
        
        // è®°å½•æˆåŠŸ
        await this.recordSuccess(provider.name, params);
        
        return result;
        
      } catch (error) {
        // è®°å½•å¤±è´¥ï¼Œå°è¯•ä¸‹ä¸€ä¸ª
        await this.recordFailure(provider.name, error);
        
        this.logger.warn(
          `ä¾›åº”å•† ${provider.name} è°ƒç”¨å¤±è´¥ï¼Œå°è¯•ä¸‹ä¸€ä¸ª`,
          error
        );
      }
    }
    
    throw new Error('æ‰€æœ‰ä¾›åº”å•†éƒ½ä¸å¯ç”¨');
  }
  
  /**
   * è·å–å¯ç”¨ä¾›åº”å•†
   */
  private async getAvailableProviders(): Promise<EnergyProvider[]> {
    const providers = await Promise.all(
      this.providers.map(async (provider) => {
        const isHealthy = await this.checkProviderHealth(provider);
        return isHealthy ? provider : null;
      })
    );
    
    return providers.filter(p => p !== null) as EnergyProvider[];
  }
  
  /**
   * å¥åº·æ£€æŸ¥
   */
  private async checkProviderHealth(provider: EnergyProvider): Promise<boolean> {
    try {
      await provider.ping();
      return true;
    } catch {
      return false;
    }
  }
  
  /**
   * æ’åºä¾›åº”å•†ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰
   */
  private sortProviders(providers: EnergyProvider[]): EnergyProvider[] {
    return providers.sort((a, b) => {
      // ç»¼åˆè€ƒè™‘ä»·æ ¼ã€æˆåŠŸç‡ã€å»¶è¿Ÿ
      const scoreA = this.calculateProviderScore(a);
      const scoreB = this.calculateProviderScore(b);
      return scoreB - scoreA; // é™åº
    });
  }
}
```

### 3.4 è‡ªåŠ¨ç§ŸèµæœåŠ¡ (Auto Rent Service)

**èŒè´£**ï¼š
- ç›‘æ§åœ°å€èƒ½é‡
- è§¦å‘è‡ªåŠ¨ç§Ÿèµ
- è§„åˆ™ç®¡ç†

```typescript
// src/services/auto-rent.service.ts

export class AutoRentService {
  /**
   * æ‰§è¡Œç›‘æ§ä»»åŠ¡ï¼ˆå®šæ—¶è§¦å‘ï¼‰
   */
  async executeMonitoring(): Promise<void> {
    // 1. è·å–æ‰€æœ‰å¯ç”¨çš„è§„åˆ™
    const rules = await this.getEnabledRules();
    
    this.logger.info(`å¼€å§‹æ‰§è¡Œç›‘æ§ä»»åŠ¡ï¼Œå…± ${rules.length} æ¡è§„åˆ™`);
    
    // 2. æ‰¹é‡æŸ¥è¯¢åœ°å€èƒ½é‡
    const addresses = rules.map(r => r.address);
    const energyMap = await this.batchGetEnergy(addresses);
    
    // 3. æ£€æŸ¥æ¯æ¡è§„åˆ™
    for (const rule of rules) {
      await this.checkAndExecuteRule(rule, energyMap[rule.address]);
    }
  }
  
  /**
   * æ£€æŸ¥å¹¶æ‰§è¡Œè§„åˆ™
   */
  private async checkAndExecuteRule(
    rule: AutoRentRule,
    currentEnergy: number
  ): Promise<void> {
    // 1. åˆ¤æ–­æ˜¯å¦æ»¡è¶³è§¦å‘æ¡ä»¶
    if (currentEnergy >= rule.triggerEnergyThreshold) {
      return; // ä¸éœ€è¦è§¦å‘
    }
    
    // 2. é˜²æ­¢é‡å¤è§¦å‘ï¼ˆè·ç¦»ä¸Šæ¬¡è§¦å‘ä¸è¶³1å°æ—¶ï¼‰
    if (rule.lastTriggerAt) {
      const hoursSinceLastTrigger = 
        (Date.now() - rule.lastTriggerAt.getTime()) / 3600000;
      
      if (hoursSinceLastTrigger < 1) {
        return; // è·ç¦»ä¸Šæ¬¡è§¦å‘å¤ªè¿‘
      }
    }
    
    this.logger.info(
      `è§„åˆ™è§¦å‘: ${rule.address} èƒ½é‡ ${currentEnergy} < ${rule.triggerEnergyThreshold}`
    );
    
    try {
      // 3. åˆ›å»ºè®¢å•
      const order = await this.orderService.createOrder({
        userId: rule.userId,
        receiverAddress: rule.address,
        energyAmount: rule.rentAmount,
        durationHours: rule.rentDurationHours,
        autoRent: true
      });
      
      // 4. æ›´æ–°è§„åˆ™çš„æœ€åè§¦å‘æ—¶é—´
      await this.updateLastTriggerTime(rule.id);
      
      // 5. å‘é€é€šçŸ¥
      await this.notificationService.sendAutoRentTriggered(rule, order);
      
    } catch (error) {
      this.logger.error(`è‡ªåŠ¨ç§Ÿèµæ‰§è¡Œå¤±è´¥: ${rule.id}`, error);
      
      // å‘é€å¤±è´¥é€šçŸ¥
      await this.notificationService.sendAutoRentFailed(rule, error.message);
    }
  }
  
  /**
   * æ‰¹é‡æŸ¥è¯¢èƒ½é‡
   */
  private async batchGetEnergy(addresses: string[]): Promise<Record<string, number>> {
    const results = await Promise.all(
      addresses.map(async (addr) => {
        try {
          const info = await this.energyService.getAddressEnergy(addr);
          return { address: addr, energy: info.energyAvailable };
        } catch {
          return { address: addr, energy: 0 };
        }
      })
    );
    
    return results.reduce((map, item) => {
      map[item.address] = item.energy;
      return map;
    }, {} as Record<string, number>);
  }
}
```

### 3.5 TG æœºå™¨äººæ¶æ„

```typescript
// src/telegram/bot.ts

export class TelegramBot {
  private bot: Telegraf;
  
  constructor() {
    this.bot = new Telegraf(config.telegram.botToken);
    this.setupMiddlewares();
    this.setupCommands();
    this.setupScenes();
  }
  
  /**
   * è®¾ç½®ä¸­é—´ä»¶
   */
  private setupMiddlewares(): void {
    // ä¼šè¯ç®¡ç†
    this.bot.use(session());
    
    // ç”¨æˆ·è®¤è¯
    this.bot.use(authMiddleware);
    
    // æ—¥å¿—è®°å½•
    this.bot.use(loggingMiddleware);
    
    // é”™è¯¯å¤„ç†
    this.bot.catch(errorHandler);
  }
  
  /**
   * æ³¨å†Œå‘½ä»¤
   */
  private setupCommands(): void {
    this.bot.command('start', startCommand);
    this.bot.command('buy', buyCommand);
    this.bot.command('balance', balanceCommand);
    this.bot.command('price', priceCommand);
    this.bot.command('orders', ordersCommand);
    this.bot.command('auto_rent', autoRentCommand);
    this.bot.command('monitor', monitorCommand);
    this.bot.command('daily', dailyReportCommand);
    this.bot.command('account', accountCommand);
    this.bot.command('help', helpCommand);
  }
  
  /**
   * è®¾ç½®åœºæ™¯ï¼ˆå¤šæ­¥éª¤å¯¹è¯ï¼‰
   */
  private setupScenes(): void {
    const stage = new Scenes.Stage<BotContext>([
      buyEnergyScene,
      autoRentScene,
      monitorScene,
      depositScene
    ]);
    
    this.bot.use(stage.middleware());
  }
  
  start(): void {
    this.bot.launch();
    this.logger.info('TG æœºå™¨äººå¯åŠ¨æˆåŠŸ');
  }
}

// src/telegram/commands/buy.command.ts
export const buyCommand = async (ctx: BotContext) => {
  await ctx.scene.enter('buyEnergy');
};

// src/telegram/scenes/buy-energy.scene.ts
export const buyEnergyScene = new Scenes.BaseScene<BotContext>('buyEnergy');

buyEnergyScene.enter(async (ctx) => {
  await ctx.reply(
    'ğŸ”‹ èƒ½é‡è´­ä¹°\n\nè¯·è¾“å…¥æ¥æ”¶åœ°å€ï¼š',
    { parse_mode: 'Markdown' }
  );
});

buyEnergyScene.on('text', async (ctx) => {
  const address = ctx.message.text;
  
  // éªŒè¯åœ°å€
  if (!TronWeb.isAddress(address)) {
    await ctx.reply('âŒ åœ°å€æ ¼å¼é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥ï¼š');
    return;
  }
  
  // ä¿å­˜åˆ°ä¼šè¯
  ctx.session.buyEnergy = { address };
  
  // æ˜¾ç¤ºæ•°é‡é€‰é¡¹
  await ctx.reply(
    'âœ… åœ°å€éªŒè¯æˆåŠŸ\n\nè¯·é€‰æ‹©èƒ½é‡æ•°é‡ï¼š',
    Markup.keyboard([
      ['32,000', '65,000'],
      ['130,000', '260,000'],
      ['è‡ªå®šä¹‰æ•°é‡']
    ]).resize()
  );
  
  return ctx.wizard.next();
});

// ... åç»­æ­¥éª¤
```

---

## 4. æ•°æ®åº“è¯¦ç»†è®¾è®¡

### 4.1 å®Œæ•´è¡¨ç»“æ„ (MySQL 8.0+)

```sql
-- ç”¨æˆ·è¡¨
CREATE TABLE users (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  telegram_id BIGINT UNIQUE,
  username VARCHAR(255),
  first_name VARCHAR(255),
  last_name VARCHAR(255),
  language_code VARCHAR(10) DEFAULT 'zh-CN',
  
  -- è´¢åŠ¡å­—æ®µ
  balance DECIMAL(20, 6) DEFAULT 0,
  frozen_balance DECIMAL(20, 6) DEFAULT 0,
  total_spent DECIMAL(20, 6) DEFAULT 0,
  
  -- API è®¤è¯
  api_key VARCHAR(64) UNIQUE,
  api_secret VARCHAR(128),
  api_enabled BOOLEAN DEFAULT TRUE,
  ip_whitelist JSON, -- IP ç™½åå•æ•°ç»„
  
  -- ä¼šå‘˜ç­‰çº§
  member_level VARCHAR(20) DEFAULT 'normal', -- normal/vip1/vip2/vip3/enterprise
  member_expires_at DATETIME,
  
  -- é‚€è¯·ç›¸å…³
  invite_code VARCHAR(20) UNIQUE,
  invited_by BIGINT,
  
  -- æ—¶é—´æˆ³
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  last_active_at DATETIME,
  
  -- ç´¢å¼•
  INDEX idx_telegram_id (telegram_id),
  INDEX idx_api_key (api_key),
  INDEX idx_invite_code (invite_code),
  FOREIGN KEY (invited_by) REFERENCES users(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- è®¢å•è¡¨
CREATE TABLE orders (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  order_id VARCHAR(64) UNIQUE NOT NULL,
  user_id BIGINT NOT NULL,
  
  -- è®¢å•ä¿¡æ¯
  receiver_address VARCHAR(50) NOT NULL,
  energy_amount BIGINT NOT NULL,
  duration_hours INT NOT NULL,
  price DECIMAL(20, 6) NOT NULL,
  
  -- çŠ¶æ€
  status VARCHAR(20) NOT NULL, -- pending/processing/completed/failed/refunded
  
  -- åŒºå—é“¾ä¿¡æ¯
  transaction_hash VARCHAR(128),
  block_number BIGINT,
  delegation_id BIGINT, -- å…³è”å§”æ‰˜è®°å½•
  
  -- æ—¶é—´
  expire_time DATETIME,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  completed_at DATETIME,
  refunded_at DATETIME,
  
  -- å¤‡æ³¨
  remark TEXT,
  error_message TEXT,
  
  -- æ˜¯å¦è‡ªåŠ¨ç»­ç§Ÿè§¦å‘
  is_auto_rent BOOLEAN DEFAULT FALSE,
  
  -- ç´¢å¼•
  INDEX idx_user_id (user_id),
  INDEX idx_order_id (order_id),
  INDEX idx_status (status),
  INDEX idx_created_at (created_at),
  INDEX idx_receiver_address (receiver_address),
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- TRX èµ„æºæ± çŠ¶æ€è¡¨
CREATE TABLE resource_pool_status (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  
  -- èµ„æºæ± ä¿¡æ¯
  total_trx DECIMAL(20, 6) NOT NULL,
  frozen_trx DECIMAL(20, 6) NOT NULL,
  available_trx DECIMAL(20, 6) NOT NULL,
  total_energy BIGINT NOT NULL,
  available_energy BIGINT NOT NULL,
  
  -- ç»Ÿè®¡ä¿¡æ¯
  active_orders INT DEFAULT 0,
  utilization_rate DECIMAL(5, 4), -- 0.0000 - 1.0000
  
  -- é’±åŒ…åœ°å€
  hot_wallet_address VARCHAR(50) NOT NULL,
  
  -- æ—¶é—´æˆ³
  recorded_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  
  INDEX idx_recorded_at (recorded_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- å§”æ‰˜è®°å½•è¡¨ï¼ˆå¹³å°è´¨æŠ¼è®°å½•ï¼‰
CREATE TABLE resource_delegations (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  order_id BIGINT NOT NULL,
  
  -- å§”æ‰˜ä¿¡æ¯
  receiver_address VARCHAR(50) NOT NULL,
  trx_amount DECIMAL(20, 6) NOT NULL,
  energy_amount BIGINT NOT NULL,
  duration_hours INT NOT NULL,
  
  -- åŒºå—é“¾ä¿¡æ¯
  freeze_tx_hash VARCHAR(128),
  delegate_tx_hash VARCHAR(128),
  
  -- çŠ¶æ€
  status VARCHAR(20) NOT NULL, -- active/expired/reclaimed
  
  -- æ—¶é—´
  start_time DATETIME NOT NULL,
  expire_time DATETIME NOT NULL,
  reclaimed_at DATETIME,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  
  -- ç´¢å¼•
  INDEX idx_order_id (order_id),
  INDEX idx_status (status),
  INDEX idx_expire_time (expire_time),
  INDEX idx_receiver_address (receiver_address),
  FOREIGN KEY (order_id) REFERENCES orders(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- è‡ªåŠ¨ç§Ÿèµè§„åˆ™è¡¨
CREATE TABLE auto_rent_rules (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  user_id BIGINT NOT NULL,
  address VARCHAR(50) NOT NULL,
  alias VARCHAR(100), -- åœ°å€åˆ«å
  
  -- è§¦å‘æ¡ä»¶
  trigger_energy_threshold BIGINT NOT NULL,
  
  -- æ‰§è¡ŒåŠ¨ä½œ
  rent_amount BIGINT NOT NULL,
  rent_duration_hours INT NOT NULL,
  
  -- çŠ¶æ€
  enabled BOOLEAN DEFAULT TRUE,
  
  -- ç»Ÿè®¡
  trigger_count INT DEFAULT 0,
  last_trigger_at DATETIME,
  
  -- æ—¶é—´
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  -- ç´¢å¼•
  INDEX idx_user_enabled (user_id, enabled),
  INDEX idx_address (address),
  UNIQUE KEY uk_user_address (user_id, address),
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ç›‘æ§åœ°å€è¡¨
CREATE TABLE monitor_addresses (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  user_id BIGINT NOT NULL,
  address VARCHAR(50) NOT NULL,
  alias VARCHAR(100),
  
  -- ç›‘æ§é€‰é¡¹
  monitor_balance BOOLEAN DEFAULT TRUE,
  monitor_energy BOOLEAN DEFAULT TRUE,
  monitor_transfers BOOLEAN DEFAULT TRUE,
  
  -- å‘Šè­¦é˜ˆå€¼
  alert_transfer_amount DECIMAL(20, 6), -- è½¬è´¦é‡‘é¢é˜ˆå€¼
  alert_energy_threshold BIGINT, -- èƒ½é‡é˜ˆå€¼
  
  -- çŠ¶æ€
  enabled BOOLEAN DEFAULT TRUE,
  
  -- æ—¶é—´
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  -- ç´¢å¼•
  INDEX idx_user_id (user_id),
  INDEX idx_address (address),
  UNIQUE KEY uk_user_address (user_id, address),
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- å……å€¼è®°å½•è¡¨
CREATE TABLE deposits (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  user_id BIGINT NOT NULL,
  
  -- äº¤æ˜“ä¿¡æ¯
  transaction_hash VARCHAR(128) UNIQUE,
  from_address VARCHAR(50),
  to_address VARCHAR(50),
  amount DECIMAL(20, 6) NOT NULL,
  
  -- çŠ¶æ€
  status VARCHAR(20) DEFAULT 'pending', -- pending/confirmed/failed
  confirmations INT DEFAULT 0,
  
  -- æ—¶é—´
  confirmed_at DATETIME,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  
  -- ç´¢å¼•
  INDEX idx_user_id (user_id),
  INDEX idx_tx_hash (transaction_hash),
  INDEX idx_status (status),
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- æç°è®°å½•è¡¨
CREATE TABLE withdrawals (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  user_id BIGINT NOT NULL,
  
  -- æç°ä¿¡æ¯
  to_address VARCHAR(50) NOT NULL,
  amount DECIMAL(20, 6) NOT NULL,
  fee DECIMAL(20, 6) DEFAULT 0,
  actual_amount DECIMAL(20, 6) NOT NULL, -- å®é™…åˆ°è´¦
  
  -- çŠ¶æ€
  status VARCHAR(20) DEFAULT 'pending', -- pending/processing/completed/failed
  
  -- åŒºå—é“¾ä¿¡æ¯
  transaction_hash VARCHAR(128),
  
  -- æ—¶é—´
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  completed_at DATETIME,
  
  -- å®¡æ ¸
  reviewed_by BIGINT,
  reviewed_at DATETIME,
  reject_reason TEXT,
  
  -- ç´¢å¼•
  INDEX idx_user_id (user_id),
  INDEX idx_status (status),
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- é€šçŸ¥è®°å½•è¡¨
CREATE TABLE notifications (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  user_id BIGINT NOT NULL,
  
  -- é€šçŸ¥ç±»å‹
  type VARCHAR(50) NOT NULL, -- order_completed/auto_rent_triggered/balance_low
  
  -- å†…å®¹
  title VARCHAR(255),
  content TEXT,
  data JSON, -- é¢å¤–æ•°æ®
  
  -- çŠ¶æ€
  is_read BOOLEAN DEFAULT FALSE,
  is_sent BOOLEAN DEFAULT FALSE,
  
  -- æ—¶é—´
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  read_at DATETIME,
  
  -- ç´¢å¼•
  INDEX idx_user_read (user_id, is_read),
  INDEX idx_created_at (created_at),
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ä»·æ ¼å†å²è¡¨
CREATE TABLE price_history (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  
  -- ä»·æ ¼ä¿¡æ¯
  energy_amount BIGINT NOT NULL,
  duration_hours INT NOT NULL,
  price DECIMAL(20, 6) NOT NULL,
  unit_price DECIMAL(12, 8) NOT NULL,
  
  -- æ—¶é—´
  recorded_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  
  -- ç´¢å¼•
  INDEX idx_recorded_at (recorded_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- æ“ä½œæ—¥å¿—è¡¨
CREATE TABLE operation_logs (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  user_id BIGINT,
  
  -- æ“ä½œä¿¡æ¯
  action VARCHAR(100) NOT NULL, -- create_order/refund/deposit/delegate_resource
  resource_type VARCHAR(50), -- order/user/rule/delegation
  resource_id BIGINT,
  
  -- è¯¦æƒ…
  ip_address VARCHAR(45),
  user_agent TEXT,
  details JSON,
  
  -- æ—¶é—´
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  
  -- ç´¢å¼•
  INDEX idx_user_id (user_id),
  INDEX idx_action (action),
  INDEX idx_created_at (created_at),
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- èƒ½é‡ä»·æ ¼é…ç½®è¡¨
CREATE TABLE energy_price_config (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  
  -- ä»·æ ¼é…ç½®
  energy_per_trx INT NOT NULL DEFAULT 1200, -- 1 TRX å¯è·å¾—çš„èƒ½é‡æ•°
  platform_fee_rate DECIMAL(5, 4) NOT NULL DEFAULT 0.05, -- å¹³å°æ‰‹ç»­è´¹ç‡ 5%
  
  -- æ—¶é•¿ç³»æ•°
  duration_multiplier JSON, -- {"1": 1.0, "6": 0.95, "24": 0.90}
  
  -- ä¼šå‘˜æŠ˜æ‰£
  member_discount JSON, -- {"vip1": 0.95, "vip2": 0.93, "vip3": 0.90}
  
  -- ç”Ÿæ•ˆæ—¶é—´
  effective_from DATETIME NOT NULL,
  effective_to DATETIME,
  
  -- æ—¶é—´
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  
  INDEX idx_effective (effective_from, effective_to)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```
  
  -- æ—¶é—´
  expire_time TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW(),
  completed_at TIMESTAMP,
  refunded_at TIMESTAMP,
  
  -- å¤‡æ³¨
  remark TEXT,
  error_message TEXT,
  
  -- æ˜¯å¦è‡ªåŠ¨ç»­ç§Ÿè§¦å‘
  is_auto_rent BOOLEAN DEFAULT false,
  
  -- ç´¢å¼•
  INDEX idx_user_id (user_id),
  INDEX idx_order_id (order_id),
  INDEX idx_status (status),
  INDEX idx_created_at (created_at),
  INDEX idx_receiver_address (receiver_address)
);

-- è‡ªåŠ¨ç§Ÿèµè§„åˆ™è¡¨
CREATE TABLE auto_rent_rules (
  id BIGSERIAL PRIMARY KEY,
  user_id BIGINT NOT NULL REFERENCES users(id),
  address VARCHAR(50) NOT NULL,
  alias VARCHAR(100), -- åœ°å€åˆ«å
  
  -- è§¦å‘æ¡ä»¶
  trigger_energy_threshold BIGINT NOT NULL,
  
  -- æ‰§è¡ŒåŠ¨ä½œ
  rent_amount BIGINT NOT NULL,
  rent_duration_hours INT NOT NULL,
  
  -- çŠ¶æ€
  enabled BOOLEAN DEFAULT true,
  
  -- ç»Ÿè®¡
  trigger_count INT DEFAULT 0,
  last_trigger_at TIMESTAMP,
  
  -- æ—¶é—´
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  
  -- ç´¢å¼•
  INDEX idx_user_enabled (user_id, enabled),
  INDEX idx_address (address),
  UNIQUE(user_id, address)
);

-- ç›‘æ§åœ°å€è¡¨
CREATE TABLE monitor_addresses (
  id BIGSERIAL PRIMARY KEY,
  user_id BIGINT NOT NULL REFERENCES users(id),
  address VARCHAR(50) NOT NULL,
  alias VARCHAR(100),
  
  -- ç›‘æ§é€‰é¡¹
  monitor_balance BOOLEAN DEFAULT true,
  monitor_energy BOOLEAN DEFAULT true,
  monitor_transfers BOOLEAN DEFAULT true,
  
  -- å‘Šè­¦é˜ˆå€¼
  alert_transfer_amount DECIMAL(20, 6), -- è½¬è´¦é‡‘é¢é˜ˆå€¼
  alert_energy_threshold BIGINT, -- èƒ½é‡é˜ˆå€¼
  
  -- çŠ¶æ€
  enabled BOOLEAN DEFAULT true,
  
  -- æ—¶é—´
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  
  -- ç´¢å¼•
  INDEX idx_user_id (user_id),
  INDEX idx_address (address),
  UNIQUE(user_id, address)
);

-- å……å€¼è®°å½•è¡¨
CREATE TABLE deposits (
  id BIGSERIAL PRIMARY KEY,
  user_id BIGINT NOT NULL REFERENCES users(id),
  
  -- äº¤æ˜“ä¿¡æ¯
  transaction_hash VARCHAR(128) UNIQUE,
  from_address VARCHAR(50),
  to_address VARCHAR(50),
  amount DECIMAL(20, 6) NOT NULL,
  
  -- çŠ¶æ€
  status VARCHAR(20) DEFAULT 'pending', -- pending/confirmed/failed
  confirmations INT DEFAULT 0,
  
  -- æ—¶é—´
  confirmed_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW(),
  
  -- ç´¢å¼•
  INDEX idx_user_id (user_id),
  INDEX idx_tx_hash (transaction_hash),
  INDEX idx_status (status)
);

-- æç°è®°å½•è¡¨
CREATE TABLE withdrawals (
  id BIGSERIAL PRIMARY KEY,
  user_id BIGINT NOT NULL REFERENCES users(id),
  
  -- æç°ä¿¡æ¯
  to_address VARCHAR(50) NOT NULL,
  amount DECIMAL(20, 6) NOT NULL,
  fee DECIMAL(20, 6) DEFAULT 0,
  actual_amount DECIMAL(20, 6) NOT NULL, -- å®é™…åˆ°è´¦
  
  -- çŠ¶æ€
  status VARCHAR(20) DEFAULT 'pending', -- pending/processing/completed/failed
  
  -- åŒºå—é“¾ä¿¡æ¯
  transaction_hash VARCHAR(128),
  
  -- æ—¶é—´
  created_at TIMESTAMP DEFAULT NOW(),
  completed_at TIMESTAMP,
  
  -- å®¡æ ¸
  reviewed_by BIGINT REFERENCES users(id),
  reviewed_at TIMESTAMP,
  reject_reason TEXT,
  
  -- ç´¢å¼•
  INDEX idx_user_id (user_id),
  INDEX idx_status (status)
);

-- é€šçŸ¥è®°å½•è¡¨
CREATE TABLE notifications (
  id BIGSERIAL PRIMARY KEY,
  user_id BIGINT NOT NULL REFERENCES users(id),
  
  -- é€šçŸ¥ç±»å‹
  type VARCHAR(50) NOT NULL, -- order_completed/auto_rent_triggered/balance_low
  
  -- å†…å®¹
  title VARCHAR(255),
  content TEXT,
  data JSONB, -- é¢å¤–æ•°æ®
  
  -- çŠ¶æ€
  read BOOLEAN DEFAULT false,
  sent BOOLEAN DEFAULT false,
  
  -- æ—¶é—´
  created_at TIMESTAMP DEFAULT NOW(),
  read_at TIMESTAMP,
  
  -- ç´¢å¼•
  INDEX idx_user_read (user_id, read),
  INDEX idx_created_at (created_at)
);

-- ä»·æ ¼å†å²è¡¨
CREATE TABLE price_history (
  id BIGSERIAL PRIMARY KEY,
  
  -- ä»·æ ¼ä¿¡æ¯
  energy_amount BIGINT NOT NULL,
  duration_hours INT NOT NULL,
  price DECIMAL(20, 6) NOT NULL,
  unit_price DECIMAL(12, 8) NOT NULL,
  
  -- ä¾›åº”å•†
  supplier_name VARCHAR(50),
  
  -- æ—¶é—´
  recorded_at TIMESTAMP DEFAULT NOW(),
  
  -- ç´¢å¼•
  INDEX idx_recorded_at (recorded_at),
  INDEX idx_supplier (supplier_name)
);

-- æ“ä½œæ—¥å¿—è¡¨
CREATE TABLE operation_logs (
  id BIGSERIAL PRIMARY KEY,
  user_id BIGINT REFERENCES users(id),
  
  -- æ“ä½œä¿¡æ¯
  action VARCHAR(100) NOT NULL, -- create_order/refund/deposit
  resource_type VARCHAR(50), -- order/user/rule
  resource_id BIGINT,
  
  -- è¯¦æƒ…
  ip_address VARCHAR(45),
  user_agent TEXT,
  details JSONB,
  
  -- æ—¶é—´
  created_at TIMESTAMP DEFAULT NOW(),
  
  -- ç´¢å¼•
  INDEX idx_user_id (user_id),
  INDEX idx_action (action),
  INDEX idx_created_at (created_at)
);
```

### 4.2 Redis æ•°æ®ç»“æ„è®¾è®¡

```
# ç”¨æˆ·ä¼šè¯ï¼ˆTG Botï¼‰
tg:session:{telegram_id} -> JSON
TTL: 30 åˆ†é’Ÿ

# åœ°å€èƒ½é‡ç¼“å­˜
energy:{address} -> JSON
TTL: 5 åˆ†é’Ÿ

# ä»·æ ¼ç¼“å­˜
price:{energy_amount}:{duration} -> JSON
TTL: 10 åˆ†é’Ÿ

# API é™æµ
ratelimit:api:{api_key} -> counter
TTL: 1 åˆ†é’Ÿ

# è®¢å•å¤„ç†é”
lock:order:{order_id} -> timestamp
TTL: 5 åˆ†é’Ÿ

# ç”¨æˆ·ä½™é¢é”
lock:balance:{user_id} -> timestamp
TTL: 10 ç§’

# ä¾›åº”å•†å¥åº·çŠ¶æ€
supplier:health:{supplier_name} -> JSON
TTL: 1 åˆ†é’Ÿ
```

---

## 5. API æ¥å£è¯¦ç»†è®¾è®¡

### 5.1 è®¤è¯æœºåˆ¶

**ç­¾åç”Ÿæˆç®—æ³•**ï¼š

```typescript
// å®¢æˆ·ç«¯ç”Ÿæˆç­¾å
function generateSignature(
  apiKey: string,
  apiSecret: string,
  timestamp: number,
  method: string,
  path: string,
  body: string
): string {
  const message = `${timestamp}${method}${path}${body}`;
  return crypto
    .createHmac('sha256', apiSecret)
    .update(message)
    .digest('hex');
}

// ç¤ºä¾‹
const timestamp = Date.now();
const method = 'POST';
const path = '/api/v1/energy/rent';
const body = JSON.stringify({ receiver_address: 'TY...', energy_amount: 65000 });

const signature = generateSignature(apiKey, apiSecret, timestamp, method, path, body);

// è¯·æ±‚å¤´
headers: {
  'X-API-KEY': apiKey,
  'X-TIMESTAMP': timestamp,
  'X-SIGNATURE': signature,
  'Content-Type': 'application/json'
}
```

**æœåŠ¡ç«¯éªŒè¯**ï¼š

```typescript
function verifySignature(req: Request): boolean {
  const apiKey = req.headers['x-api-key'];
  const timestamp = parseInt(req.headers['x-timestamp']);
  const signature = req.headers['x-signature'];
  
  // 1. æ£€æŸ¥æ—¶é—´æˆ³ï¼ˆé˜²é‡æ”¾æ”»å‡»ï¼‰
  const now = Date.now();
  if (Math.abs(now - timestamp) > 60000) { // 60ç§’å†…æœ‰æ•ˆ
    throw new Error('è¯·æ±‚å·²è¿‡æœŸ');
  }
  
  // 2. è·å–ç”¨æˆ·çš„ apiSecret
  const user = await getUserByApiKey(apiKey);
  if (!user) {
    throw new Error('API Key æ— æ•ˆ');
  }
  
  // 3. ç”Ÿæˆç­¾åå¹¶å¯¹æ¯”
  const message = `${timestamp}${req.method}${req.path}${req.body}`;
  const expectedSignature = crypto
    .createHmac('sha256', user.apiSecret)
    .update(message)
    .digest('hex');
  
  return signature === expectedSignature;
}
```

### 5.2 å®Œæ•´ API åˆ—è¡¨

```typescript
// API è·¯ç”±å®šä¹‰
const apiRoutes = {
  // èƒ½é‡ç›¸å…³
  'POST /api/v1/energy/rent': 'ç§Ÿèµèƒ½é‡',
  'GET /api/v1/energy/price': 'æŸ¥è¯¢ä»·æ ¼',
  'GET /api/v1/energy/balance': 'æŸ¥è¯¢åœ°å€èƒ½é‡',
  
  // è®¢å•ç›¸å…³
  'GET /api/v1/orders/:id': 'æŸ¥è¯¢è®¢å•è¯¦æƒ…',
  'GET /api/v1/orders': 'æŸ¥è¯¢è®¢å•åˆ—è¡¨',
  'POST /api/v1/orders/:id/cancel': 'å–æ¶ˆè®¢å•',
  
  // è´¦æˆ·ç›¸å…³
  'GET /api/v1/account/balance': 'æŸ¥è¯¢è´¦æˆ·ä½™é¢',
  'GET /api/v1/account/profile': 'æŸ¥è¯¢è´¦æˆ·ä¿¡æ¯',
  'POST /api/v1/account/api-key': 'ç”ŸæˆAPIå¯†é’¥',
  'DELETE /api/v1/account/api-key/:id': 'åˆ é™¤APIå¯†é’¥',
  
  // è‡ªåŠ¨ç§Ÿèµ
  'POST /api/v1/auto-rent/rules': 'åˆ›å»ºè‡ªåŠ¨ç§Ÿèµè§„åˆ™',
  'GET /api/v1/auto-rent/rules': 'æŸ¥è¯¢è§„åˆ™åˆ—è¡¨',
  'PUT /api/v1/auto-rent/rules/:id': 'æ›´æ–°è§„åˆ™',
  'DELETE /api/v1/auto-rent/rules/:id': 'åˆ é™¤è§„åˆ™',
  'POST /api/v1/auto-rent/rules/:id/toggle': 'å¯ç”¨/ç¦ç”¨è§„åˆ™',
  
  // ç›‘æ§
  'POST /api/v1/monitor/addresses': 'æ·»åŠ ç›‘æ§åœ°å€',
  'GET /api/v1/monitor/addresses': 'æŸ¥è¯¢ç›‘æ§åˆ—è¡¨',
  'DELETE /api/v1/monitor/addresses/:id': 'åˆ é™¤ç›‘æ§',
  
  // ç»Ÿè®¡
  'GET /api/v1/statistics/dashboard': 'ä»ªè¡¨æ¿æ•°æ®',
  'GET /api/v1/statistics/orders': 'è®¢å•ç»Ÿè®¡',
};
```

---

## 6. éƒ¨ç½²æ–¹æ¡ˆ

### 6.1 Docker éƒ¨ç½²

**docker-compose.yml**ï¼š

```yaml
version: '3.8'

services:
  # MySQL æ•°æ®åº“
  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MYSQL_DATABASE: tron_energy
      MYSQL_USER: ${DB_USER}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    volumes:
      - mysql_data:/var/lib/mysql
      - ./docker/mysql/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "3306:3306"
    command: --default-authentication-plugin=mysql_native_password --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "${DB_USER}", "-p${DB_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5
  
  # Redis ç¼“å­˜
  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
  
  # API æœåŠ¡
  api:
    build:
      context: .
      dockerfile: docker/Dockerfile
      target: api
    environment:
      NODE_ENV: production
      DB_HOST: mysql
      DB_PORT: 3306
      REDIS_HOST: redis
      REDIS_PORT: 6379
    ports:
      - "3000:3000"
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    deploy:
      replicas: 2
      resources:
        limits:
          cpus: '1'
          memory: 1G
  
  # TG æœºå™¨äºº
  telegram-bot:
    build:
      context: .
      dockerfile: docker/Dockerfile
      target: telegram
    environment:
      NODE_ENV: production
      DB_HOST: mysql
      DB_PORT: 3306
      REDIS_HOST: redis
      REDIS_PORT: 6379
      TG_BOT_TOKEN: ${TG_BOT_TOKEN}
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
  
  # Worker åå°ä»»åŠ¡
  worker:
    build:
      context: .
      dockerfile: docker/Dockerfile
      target: worker
    environment:
      NODE_ENV: production
      DB_HOST: mysql
      DB_PORT: 3306
      REDIS_HOST: redis
      REDIS_PORT: 6379
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    deploy:
      replicas: 2
  
  # Nginx åå‘ä»£ç†
  nginx:
    image: nginx:alpine
    volumes:
      - ./docker/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - api
    restart: unless-stopped

volumes:
  mysql_data:
  redis_data:
```

**Dockerfile**ï¼š

```dockerfile
# æ„å»ºé˜¶æ®µ
FROM node:20-alpine AS builder

WORKDIR /app

# å®‰è£…ä¾èµ–
COPY package*.json ./
RUN npm ci --only=production

# å¤åˆ¶æºç 
COPY . .

# ç¼–è¯‘ TypeScript
RUN npm run build

# API æœåŠ¡
FROM node:20-alpine AS api
WORKDIR /app
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/node_modules ./node_modules
COPY package.json ./
EXPOSE 3000
CMD ["node", "dist/api/server.js"]

# TG æœºå™¨äºº
FROM node:20-alpine AS telegram
WORKDIR /app
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/node_modules ./node_modules
COPY package.json ./
CMD ["node", "dist/telegram/bot.js"]

# Worker
FROM node:20-alpine AS worker
WORKDIR /app
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/node_modules ./node_modules
COPY package.json ./
CMD ["node", "dist/workers/index.js"]
```

### 6.2 ç›‘æ§å‘Šè­¦

**Prometheus é…ç½®**ï¼š

```yaml
# prometheus.yml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'tron-energy-api'
    static_configs:
      - targets: ['api:3000']
  
  - job_name: 'postgres'
    static_configs:
      - targets: ['postgres-exporter:9187']
  
  - job_name: 'redis'
    static_configs:
      - targets: ['redis-exporter:9121']
```

**Grafana ä»ªè¡¨æ¿**ï¼š
- API è¯·æ±‚é‡ã€å»¶è¿Ÿã€é”™è¯¯ç‡
- è®¢å•å¤„ç†æƒ…å†µ
- ç³»ç»Ÿèµ„æºä½¿ç”¨ç‡
- æ•°æ®åº“è¿æ¥æ± çŠ¶æ€

---

## 7. å®‰å…¨åŠ å›º

### 7.1 API å®‰å…¨

- HTTPS å¼ºåˆ¶
- ç­¾åéªŒè¯
- é¢‘ç‡é™åˆ¶
- IP ç™½åå•
- å‚æ•°éªŒè¯
- SQL æ³¨å…¥é˜²æŠ¤
- XSS é˜²æŠ¤

### 7.2 æ•°æ®å®‰å…¨

- æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨
- æ•°æ®åº“è¿æ¥åŠ å¯†
- å®šæœŸå¤‡ä»½
- è®¿é—®æ—¥å¿—å®¡è®¡

### 7.3 è¿ç»´å®‰å…¨

- æœ€å°æƒé™åŸåˆ™
- å®šæœŸå®‰å…¨æ‰«æ
- ä¾èµ–æ¼æ´æ£€æµ‹
- å®‰å…¨æ›´æ–°åŠæ—¶åº”ç”¨

---

## 8. æ€§èƒ½ä¼˜åŒ–

### 8.1 æ•°æ®åº“ä¼˜åŒ–

- åˆç†ä½¿ç”¨ç´¢å¼•
- æŸ¥è¯¢ä¼˜åŒ–
- è¿æ¥æ± é…ç½®
- è¯»å†™åˆ†ç¦»ï¼ˆå¿…è¦æ—¶ï¼‰
- åˆ†åŒºè¡¨ï¼ˆå¤§æ•°æ®é‡æ—¶ï¼‰

### 8.2 ç¼“å­˜ç­–ç•¥

- çƒ­ç‚¹æ•°æ®ç¼“å­˜
- æŸ¥è¯¢ç»“æœç¼“å­˜
- ç¼“å­˜é¢„çƒ­
- ç¼“å­˜ç©¿é€é˜²æŠ¤

### 8.3 åº”ç”¨ä¼˜åŒ–

- å¼‚æ­¥å¤„ç†
- æ‰¹é‡æ“ä½œ
- è¿æ¥å¤ç”¨
- ä»£ç ä¼˜åŒ–

---

## 9. æµ‹è¯•ç­–ç•¥

### 9.1 å•å…ƒæµ‹è¯•

```typescript
// ç¤ºä¾‹ï¼šè®¢å•æœåŠ¡æµ‹è¯•
describe('OrderService', () => {
  let orderService: OrderService;
  
  beforeEach(() => {
    orderService = new OrderService();
  });
  
  test('åˆ›å»ºè®¢å•æˆåŠŸ', async () => {
    const params = {
      userId: 1,
      receiverAddress: 'TYxxxxxxxxxxxxx',
      energyAmount: 65000,
      durationHours: 1
    };
    
    const order = await orderService.createOrder(params);
    
    expect(order).toBeDefined();
    expect(order.status).toBe(OrderStatus.PENDING);
  });
  
  test('ä½™é¢ä¸è¶³æ—¶åˆ›å»ºè®¢å•å¤±è´¥', async () => {
    // ...
  });
});
```

### 9.2 é›†æˆæµ‹è¯•

- API æ¥å£æµ‹è¯•
- æ•°æ®åº“æ“ä½œæµ‹è¯•
- ç¬¬ä¸‰æ–¹æœåŠ¡é›†æˆæµ‹è¯•

### 9.3 E2E æµ‹è¯•

- å®Œæ•´ä¸šåŠ¡æµç¨‹æµ‹è¯•
- TG æœºå™¨äººäº¤äº’æµ‹è¯•

---

## 10. å¼€å‘è§„èŒƒ

### 10.1 ä»£ç è§„èŒƒ

- ESLint + Prettier
- å‘½åè§„èŒƒ
- æ³¨é‡Šè§„èŒƒ
- Git commit è§„èŒƒ

### 10.2 åˆ†æ”¯ç®¡ç†

```
main - ç”Ÿäº§ç¯å¢ƒ
develop - å¼€å‘ç¯å¢ƒ
feature/* - åŠŸèƒ½åˆ†æ”¯
hotfix/* - ç´§æ€¥ä¿®å¤
```

### 10.3 å‘å¸ƒæµç¨‹

1. åŠŸèƒ½å¼€å‘ â†’ feature åˆ†æ”¯
2. åˆå¹¶åˆ° develop â†’ æµ‹è¯•ç¯å¢ƒ
3. æµ‹è¯•é€šè¿‡ â†’ åˆå¹¶åˆ° main
4. æ‰“ tag â†’ éƒ¨ç½²ç”Ÿäº§

---

## é™„å½•

### A. ç¯å¢ƒå˜é‡é…ç½®

```.env
# åº”ç”¨
NODE_ENV=production
PORT=3000

# MySQL æ•°æ®åº“
DB_HOST=localhost
DB_PORT=3306
DB_USER=tron_energy
DB_PASSWORD=your_password
DB_NAME=tron_energy
DB_ROOT_PASSWORD=your_root_password

# Redis
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=your_redis_password

# TRON åŒºå—é“¾
TRON_FULL_HOST=https://api.trongrid.io
TRON_PRIVATE_KEY=your_private_key_hex
TRON_HOT_WALLET_ADDRESS=TYourHotWalletAddress
TRON_API_KEY=your_trongrid_api_key

# Telegram
TG_BOT_TOKEN=your_bot_token

# JWT
JWT_SECRET=your_jwt_secret
JWT_EXPIRES_IN=7d

# API å®‰å…¨
API_RATE_LIMIT=100
API_RATE_WINDOW=60000

# èµ„æºæ± é…ç½®
RESOURCE_POOL_MIN_TRX=10000
RESOURCE_POOL_WARNING_THRESHOLD=0.8
ENERGY_PER_TRX=1200

# ä»·æ ¼é…ç½®
PLATFORM_FEE_RATE=0.05
MIN_ENERGY_AMOUNT=32000
```

---

**æ–‡æ¡£å®Œæˆ**ï¼Œå¯ä»¥å¼€å§‹å¼€å‘äº†ï¼ ğŸš€
