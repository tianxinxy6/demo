<div align="center">

# TRON 能量租赁平台

### 📄 项目需求与进度说明

**版本：** v1.0 ｜ **更新日期：** 2026-01-05

</div>

---

## 0. 文档快速导览

- 🎯 项目整体概述：一句话说明我们在做什么
- 🧭 项目目标：用户想得到什么、平台要做到什么
- 🗺️ 范围与里程碑：每个阶段做什么 + 进度
- 🔁 业务流程：从“下单”到“能量回收”的全链路
- 🛡️ 安全与风控设计：从入口到链上、从数据到运维
- 🧩 各模块安全进度：API / 机器人 / 资源池 / 日志
- ⚠️ 风险清单与对策：有哪些坑、我们怎么避免
- ✅ 测试与验收：什么标准才叫“可以放心上线”

---

## 1. 这到底是个什么平台？

可以把 TRON 能量租赁平台理解成：

> **“平台帮你先冻一批 TRX 换能量，然后按需把能量租给用户，用完再收回。”**

更细一点，可以拆成两步：

1. 平台自己先“存”一批 TRX 到链上，换成可以出租的能量。
2. 用户需要能量时，通过 API 或 Telegram 机器人下单，平台把能量临时“借”给用户使用，到期后自动收回。

在整个过程中，我们最关心三件事：

- 🔐 **资金安全**：平台自有 TRX 和用户预付的 TRX 不被盗、不被滥用。
- 📦 **业务可靠**：用户下单后，能量能按时、按量到账，异常时能及时退款或处理。
- 🧾 **可追踪、可审计**：每一笔操作、每一次链上交易，都能在后台查到“谁、什么时候、做了什么”。

---

## 2. 项目目标（站在用户 & 平台双视角）

### 2.1 用户侧希望得到什么？

- 🧩 **简单易用**：
   - 不会写代码的用户，用 TG 机器人也能从头到尾完成购买。
   - 会写代码的用户，可以用 API 一次性对接，自动化跑单。
- 💰 **价格透明**：
   - 下单前就能看到实时价格和折扣规则，没有“隐藏费用”。
- 👀 **状态清晰**：
   - 随时能查：订单现在到哪一步、能量有没有到账、什么时候到期。
- 🔒 **安全可靠**：
   - 不需要把自己的私钥交给平台。
   - 不需要先充值一大笔 TRX 才能体验服务。

### 2.2 平台侧要做到什么？

- 🧱 **稳定运营**：
   - 订单多了之后，系统依然能正常工作，不频繁超时或挂掉。
- 🧮 **资金可控**：
   - 平台的 TRX 资产始终在可控范围内，所有链上操作都有严格校验流程。
- 🕵️ **风控可持续**：
   - 能快速识别异常行为（比如疯狂刷接口、大量小额异常订单），并自动限速、拦截或告警。
- 🔍 **可审计**：
   - 事后可以还原一次问题订单或安全事件的完整过程，方便内部追责或外部审计。

---

## 3. 范围与里程碑（带进度 & 安全重点）

### 3.1 阶段划分一览

| 阶段 | 时间预估 | 主要目标 | 安全 & 风控重点 | 当前状态 |
|------|----------|----------|------------------|----------|
| Phase 1：MVP 版本 | 4 周 | 基础功能：下单、质押、委托、TG 机器人基础 | 接口签名、基础限流、操作日志 | ✅ 已完成 |
| Phase 2：增强版 | 4 周 | 自动租赁、钱包监控、日报、Web 管理后台 | 余额预警、风控规则、黑白名单 | 🚧 进行中 |
| Phase 3：企业版 | 4 周 | 批量 API、高级统计、多语言 SDK、白标方案 | 企业级权限管理、审计报表 | ⏳ 未开始 |

> 🔎 小提示：安全与风控不会只在某一个阶段完成，而是**从一开始就有基础能力，随着业务量逐步增强**。

### 3.2 安全相关里程碑

- ✅ **M1：基础安全接入**  
   - API Key 机制
   - 请求签名校验
   - 基础 IP 白名单
   - 简单接口限流

- 🚧 **M2：平台资金安全框架**  
   - 私钥只在服务端安全模块使用，不在日志中出现，存储在 vault 中，并且当前钱包私钥有且只能操作能量的API，不可以转账
   - 资源池（TRX 储备）实时监控和告警
   - 单笔订单和单用户的额度限制

- ⏳ **M3：风控规则与黑名单体系**  
   - 针对恶意刷单、频繁失败订单、异常 IP 的封禁和限速
   - 针对高风险地址的额外确认（如人工复核或二次验证）

- ⏳ **M4：审计报表与合规支持**  
   - 导出操作日志、资金流向、订单统计
   - 为后续安全审计或外部评估提供数据基础

---

## 4. 一笔订单从哪里来，到哪里去？（含安全提示）

下面用一条典型订单的“旅程”来说明整套流程，并在每一步标记安全要点：

### 步骤 1：用户发起请求

- 方式一：调用平台 API。
- 方式二：在 Telegram 里与机器人对话。

**安全要点：**
- API 请求必须带上平台分配的身份信息和签名。
- TG 机器人只识别绑定过的账号或安全指令，避免被伪造指令误导。

---

### 步骤 2：平台校验请求

- 检查参数是否合法（地址格式、数量是否在允许范围内）。
- 检查用户余额是否足够、账号是否有风险记录。

**安全要点：**
- 对超出正常范围的能量数量、异常频繁的请求，触发风控规则：
   - 直接拦截，或
   - 进入人工复核流程。

---

### 步骤 3：创建订单并锁定资金

- 在数据库中记录订单信息。
- 将本次订单需要用到的 TRX 金额“锁定”，避免被重复使用。

**安全要点：**
- 同一订单只允许被处理一次，避免并发重复扣费。
- 订单状态变更要有完整记录，方便事后追踪和审计。

---

### 步骤 4：链上质押并委托能量

- 平台使用自己的 TRX 调用 TRON 链接口：
   - 先质押换能量；
   - 再把能量委托到用户地址。

**安全要点：**
- 所有链上操作统一走封装好的服务，不允许业务代码直接接触私钥。
- 每一笔链上交易都记录交易哈希和结果，失败可自动重试或退款。

---

### 步骤 5：订单完成与结果通知

- 操作成功后，更新订单状态为“已完成”。
- 通知方式：Webhook 回调、TG 消息、后台显示等。

**安全要点：**
- Webhook 通知带签名，防止被伪造或篡改。
- 通知内容避免暴露敏感信息（如完整私钥、内部错误堆栈等）。

---

### 步骤 6：到期回收与资源池更新

- 到期后，能量自动回到平台地址。
- 平台更新资源池状态，统计可用额度。

**安全要点：**
- 定时任务只更新到期记录，不做多余的链上转账，降低误操作风险。
- 如发现状态不一致（例如订单显示“未到期”但链上已结束），进入人工处理队列。

---

## 5. 安全与风控总体思路

### 5.1 设计原则（用简单话来讲）

- 🔑 **最小权限**：什么东西只给“必须要用到它”的人或模块用，多一分都是风险。
- ✅ **多重校验**：关键操作不能只靠一个条件说了算，需要多条规则一起通过。
- 🔄 **可回滚**：一旦失败或出错，要有“撤回键”——比如退款、撤单、重试等。
- 🧾 **全程留痕**：谁在什么时候做了什么事情，都要能查得到。
- 📈 **逐步增强**：先把基础能力搭好，再根据真实业务情况持续补充规则，而不是一开始就做得过于复杂。

### 5.2 接入安全（API & TG）

**需求要点：**

- 为每个用户生成独立的 API Key 和密钥。
- API 请求必须带时间戳和签名，平台验证通过后才执行。
- 支持 IP 白名单：只允许在指定服务器或网络环境中调用。
- 按用户、按 IP 做访问频率限制，防止“暴力刷接口”。
- 对批量下单等敏感接口，额外提高安全和限流等级。

**当前进度：**

- ✅ API Key 基础机制完成。
- ✅ 请求签名与时间戳校验完成。
- ✅ 基础限流接入网关层（不同用户等级可设置不同阈值）。
- 🚧 IP 白名单在管理后台配置能力开发中。

### 5.3 账户与资金安全

**需求要点：**

- 平台 TRX 资产集中在受控的钱包中，平时只少量使用“热钱包”做日常交易。
- 私钥只保存在安全配置里，不写在代码里，不出现在日志里。
- 为单个用户设置：每日消费上限、单笔能量上限、未完成订单数上限等。
- 对异常订单（金额特别大、短时间内大量下单）自动打标，进入待复核列表。

**当前进度：**

- ✅ 平台钱包地址已统一管理，按环境（测试 / 正式）隔离。
- ✅ 私钥通过环境变量读取，不随代码分发。
- 🚧 单用户额度限制规则在开发与联调中。
- ⏳ 异常大额订单人工复核流程设计中。

### 5.4 链上操作安全

**需求要点：**

- 所有链上调用统一通过 `tron.service`，业务层不能直接操作 TronWeb 客户端。
- 在质押、解质押、委托前，必须检查资源池当前状态和安全阈值。
- 为每一笔链上交易记录详细信息：请求参数、交易哈希、链上回执、重试次数等。
- 若链上回执失败或长时间未确认：
   - 自动重试若干次；
   - 最终失败则回滚订单并退款，同时发出告警。

**当前进度：**

- ✅ 链上调用已集中在 `tron.service` 和区块链接口层中。
- ✅ 质押、委托操作的基本参数校验完成。
- 🚧 链上失败自动重试和异常报警正在实现中。

### 5.5 数据与隐私安全

**需求要点：**

- 用户敏感信息（如联系方式、备注等）在数据库中加密或脱敏存储。
- 对外展示（TG 消息、后台列表）避免暴露完整地址和敏感细节，可做部分隐藏。
- 严格区分测试与生产数据，防止测试账号混入正式数据。

**当前进度：**

- ✅ 数据库层已预留加密字段和工具库。
- 🚧 具体字段加密策略正在落地，优先保障手机号、邮箱等。

### 5.6 运维与监控安全

**需求要点：**

- 系统健康：CPU、内存、接口耗时、错误率等，要在监控大盘上实时可见。
- 业务健康：订单成功率、资源池利用率、TRX 余额、失败订单数等，要有关键指标。
- 多级告警：
   - 一般告警（如资源偏紧）可以走 TG 群或普通通知；
   - 严重告警（如余额不足、大量失败单）需要短信 / 邮件等更强提醒。

**当前进度：**

- ✅ 基础监控指标和日志采集已接入。
- 🚧 业务级告警规则和通知策略配置中。

---

## 6. 模块级需求与安全进度一览

### 6.1 API 模块

**主要做什么？**

- 提供下单、查订单、查价格、查余额等接口。
- 支持 Webhook 回调订单结果和余额预警。

**安全上要求什么？**

- 每个接口都要验证签名和时间戳，防止请求被篡改或被“重放”。
- Webhook 回调体中增加签名字段，让用户能验证通知是否真实来自平台。
- 对可能被滥用的接口（如价格查询、批量下单）增加单 IP / 单 Key 频率限制。

**当前进度：**

- ✅ 核心接口已实现并完成基础联调。
- ✅ 回调签名设计完成并应用在主要回调中。
- 🚧 接口级细化限流规则在灰度上线中。

### 6.2 TG 机器人模块

**主要做什么？**

- 支持命令：购买能量、查询钱包、查询价格、查看订单、设置自动租赁等。

**安全上要求什么？**

- 一个 Telegram 账号对应一个平台账号，避免“串号”。
- 在确认订单前，再次展示价格、地址等关键信息，给用户一个“最后确认”的机会。
- 对高金额订单或频繁操作，增加二次确认或明显风控提示。

**当前进度：**

- ✅ 主要命令流程已打通（购买、查询等）。
- 🚧 用户绑定 / 解绑流程和异常提示正在优化中。

### 6.3 资源池与订单模块

**主要做什么？**

- 管理平台 TRX 储备、已质押额度、可用能量等核心数据。
- 维护订单从“创建 → 处理中 → 完成 / 退款”的全生命周期。

**安全上要求什么？**

- 设置资源池最低余额、最高利用率阈值：
   - 低于阈值时发出告警，必要时限制接单。
- 每一笔订单都要能对上对应的链上交易，确保账目清晰。

**当前进度：**

- ✅ 基础资源池统计和订单生命周期管理已完成。
- 🚧 资源池阈值和自动限流策略在联调中。

### 6.4 日志与审计模块

**主要做什么？**

- 记录关键操作：登录、配置修改、价格调整、手工处理订单等。
- 支持按时间、账号、操作类型等多维度查询日志。

**安全上要求什么？**

- 日志中不记录明文敏感信息（完整私钥、密码等）。
- 支持日志导出，用于安全审计或合规检查。

**当前进度：**

- ✅ 日志采集与查询基础能力已具备。
- ⏳ 日志导出与权限细分设计中。

---

## 7. 风险清单与应对措施（表格版）

| 风险类型 | 风险说明 | 应对措施 | 当前进度 |
|----------|----------|----------|----------|
| 资金安全 | 平台热钱包被攻击，TRX 资产损失 | 钱包分级管理、环境隔离、最小必要余额、私钥安全存储 | 🚧 进行中 |
| 滥用与刷量 | 恶意脚本大量调用接口，消耗资源、影响正常用户 | 限流、黑名单、异常行为识别与封禁 | 🚧 进行中 |
| 系统稳定性 | 高并发或外部依赖异常导致系统不可用 | 限流、熔断、自动扩容、重试机制 | 🚧 进行中 |
| 链上异常 | TRON 网络拥堵或交易失败导致订单延迟 | 超时重试、失败退款、用户可见的状态提示 | ✅ 基础方案已实现 |
| 合规与审计 | 资金流向不清晰，后续审计困难 | 完整的日志记录和可导出的报表 | ⏳ 设计中 |

---

## 8. 测试与验收标准（安全相关）

在正式对外提供服务前，至少需要通过以下几类测试：

1. **接口安全测试**  
    - 场景：伪造签名、重复请求、参数越界等。  
    - 通过标准：异常请求被正确拦截并记录，正常请求不受影响。

2. **压力与限流测试**  
    - 场景：模拟高并发调用，观察系统在压力下的表现。  
    - 通过标准：达到预设上限后，接口返回明确错误码，后台产生告警，而不是直接宕机。

3. **链上异常场景测试**  
    - 场景：TRON 网络延迟、交易失败等。  
    - 通过标准：订单最终要么成功，要么失败并退款，不会长时间停留在“处理中”。

4. **权限与审计测试**  
    - 场景：不同角色登录后台，尝试查看和操作不同功能。  
    - 通过标准：权限边界清晰，关键配置修改都能在日志中查到记录。

---

## 9. 当前整体进度总结 & 下一步计划

**截至 2026-01-05 的整体情况：**

- ✅ 需求文档已完成
- ✅ 技术方案已确定
- ✅ 数据库设计完成
- ✅ 业务流程已明确

**📅 下一步**

开始编码，预计 4 周完成 MVP 版本，🎯 目标：年前出第一个版本