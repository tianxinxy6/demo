# TRON能量租赁平台 - 重构完成总结

## 已完成工作

### 1. 架构重新设计 ✅

- 创建了清晰的两系统分离架构文档（docs/架构设计v2.md）
- API商户系统和TG机器人系统完全独立
- 共享基础设施层

### 2. 实体层重构 ✅

**位置：** `src/entity/`

**API商户系统实体：**

- ✅ merchant.entity.ts - 商户表
- ✅ merchant-order.entity.ts - 商户订单表
- ✅ merchant-wallet.entity.ts - 商户钱包表

**TG机器人系统实体：**

- ✅ tg-user.entity.ts - TG用户表

**共享基础设施实体：**

- ✅ resource-pool.entity.ts - 资源池表
- ✅ delegation.entity.ts - 委托记录表

**特点：**

- 表名使用单数（merchant, resource_pool等）
- 不使用enum，使用 tinyint + 常量对象
- 字段名简化（receiverAddr, errorMsg等）
- 继承 CommonEntity 基类

### 3. 目录结构创建 ✅

```
src/
├── entity/                    # 实体层（已创建）
│   ├── merchant.entity.ts
│   ├── merchant-order.entity.ts
│   ├── merchant-wallet.entity.ts
│   ├── tg-user.entity.ts
│   ├── resource-pool.entity.ts
│   ├── delegation.entity.ts
│   └── index.ts
│
└── module/                    # 模块层（已创建目录）
    ├── merchant-api/          # API商户系统
    ├── telegram-bot/          # TG机器人系统
    └── shared/                # 共享基础模块
```

---

## 需要完成的工作

### 待删除的旧代码

由于旧的 `src/modules` 目录还存在，导致编译错误。需要：

1. 删除所有引用旧模块的导入
2. 或者完全删除旧的 modules 目录

### 下一步开发计划

#### 第一阶段：核心基础（1-2天）

1. 完善共享基础模块
   - TronService（TRON链交互）
   - ResourcePoolService（资源池管理）
   - DelegationService（委托管理）

2. 创建通用服务
   - 加密服务
   - 签名验证服务
   - Webhook通知服务

#### 第二阶段：API商户系统（3-5天）

1. 商户管理模块
   - 商户注册、审核
   - API Key生成和管理
   - IP白名单验证

2. 订单管理模块
   - 订单创建API
   - 订单处理流程
   - 自动续租逻辑

3. 钱包管理模块
   - 充值接口
   - 提现审核
   - 余额查询

4. 监控模块
   - 地址监控
   - 自动租赁触发

#### 第三阶段：TG机器人系统（2-3天）

1. 用户管理模块
   - 用户注册
   - 邀请系统

2. 机器人交互模块
   - 命令处理器
   - 键盘布局
   - 消息处理

#### 第四阶段：集成测试（1-2天）

1. 单元测试
2. 集成测试
3. E2E测试

---

## 关键设计决策

### 1. 表命名规范

- ✅ 使用单数：merchant, order, delegation
- ✅ 前缀区分：merchant_order, merchant_wallet, tg_user

### 2. 状态管理

- ✅ 不使用enum类型
- ✅ 使用tinyint + 常量对象

```typescript
export const OrderStatus = {
  PENDING: 1,
  PROCESSING: 2,
  COMPLETED: 3,
} as const;
```

### 3. 系统隔离

- ✅ 商户和用户完全独立的表
- ✅ 独立的认证机制
- ✅ 独立的业务流程
- ✅ 共享资源池和委托记录

### 4. 字段命名

- ✅ 使用下划线命名：created_at, updated_at
- ✅ 简化长字段名：receiverAddr, errorMsg

---

## 建议的下一步操作

### 选项A：清理后继续

```bash
# 1. 完全删除旧代码（如果不需要）
rm -rf src/modules

# 2. 更新 app.module.ts 移除旧模块引用
# 3. 开始实现新模块
```

### 选项B：保留旧代码逐步迁移

```bash
# 1. 重命名旧目录
mv src/modules src/modules_old

# 2. 逐个模块迁移
# 3. 完成后删除旧目录
```

---

## 技术栈

- **框架：** NestJS 11.x
- **数据库：** MySQL 8.0 + TypeORM
- **缓存：** Redis 7.x
- **语言：** TypeScript 5.x
- **Node：** 20.x

---

## 联系方式

如需继续开发，请确认：

1. 是否删除旧的 src/modules 目录？
2. 是否需要我继续实现具体的业务模块？
3. 优先级是API商户系统还是TG机器人系统？

---

最后更新：2026-01-05
