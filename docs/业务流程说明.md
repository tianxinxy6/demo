# TRON 能量租赁平台 - 业务流程说明

**版本**: v1.0  
**日期**: 2026年1月4日

---

## 1. 核心业务模式

### 1.1 自主质押模式

平台采用**自主质押模式**运营，具体流程如下：

```
┌─────────────────────────────────────────────────────────┐
│                  平台业务模式                            │
└─────────────────────────────────────────────────────────┘

1️⃣ 平台准备阶段
   ↓
   平台持有 TRX 资产（热钱包）
   例如：100,000 TRX
   ↓
   
2️⃣ 用户下单
   ↓
   用户通过 API/TG 机器人下单
   请求租赁 65,000 能量，1小时
   ↓
   
3️⃣ 平台质押 TRX
   ↓
   调用 TronWeb: freezeBalanceV2()
   质押约 55 TRX (65000 ÷ 1200)
   获取 65,000 能量
   ↓
   
4️⃣ 委托能量给用户
   ↓
   调用 TronWeb: delegateResource()
   将 65,000 能量委托到用户地址
   锁定期：1 小时（3600秒）
   ↓
   
5️⃣ 用户使用能量
   ↓
   用户地址获得 65,000 能量
   可用于智能合约交互和转账
   ↓
   
6️⃣ 自动到期回收
   ↓
   1小时后委托自动到期
   能量自动回到平台账户
   TRX 解冻可再次使用
```

### 1.2 与第三方供应商模式对比

| 特性 | 自主质押模式（我们） | 第三方供应商模式 |
|------|-------------------|-----------------|
| **资金控制** | 平台完全控制 TRX 资产 | 依赖第三方供应商 |
| **利润空间** | 更高，无中间商 | 较低，需分成给供应商 |
| **响应速度** | 快，直接链上操作 | 慢，需调用第三方 API |
| **稳定性** | 高，自主可控 | 依赖供应商稳定性 |
| **初始投入** | 需要大量 TRX 储备 | 无需前期投入 |
| **风险** | 市场价格波动风险 | 供应商跑路风险 |

---

## 2. 详细技术流程

### 2.1 订单处理流程

```typescript
// 完整的订单处理流程

async function processOrder(order: Order): Promise<void> {
  // 1. 验证订单
  validateOrder(order);
  
  // 2. 检查资源池状态
  const poolStatus = await resourcePoolService.getPoolStatus();
  if (poolStatus.availableTRX < calculateRequiredTRX(order.energyAmount)) {
    throw new Error('资源池 TRX 不足');
  }
  
  // 3. 计算所需 TRX
  const trxAmount = calculateRequiredTRX(order.energyAmount, order.durationHours);
  // 例如：65,000 能量 ÷ 1200 (每TRX能量) = 54.17 TRX
  
  // 4. 质押 TRX 获取能量
  const freezeTx = await tronService.freezeBalanceV2({
    amount: trxAmount,
    resource: 'ENERGY'
  });
  
  // 5. 委托能量给用户
  const delegateTx = await tronService.delegateResource({
    receiverAddress: order.receiverAddress,
    balance: trxAmount,
    resource: 'ENERGY',
    lock: true,
    lockPeriod: order.durationHours * 3600
  });
  
  // 6. 记录委托信息
  await db.resourceDelegations.create({
    orderId: order.id,
    receiverAddress: order.receiverAddress,
    trxAmount: trxAmount,
    energyAmount: order.energyAmount,
    durationHours: order.durationHours,
    freezeTxHash: freezeTx.txid,
    delegateTxHash: delegateTx.txid,
    status: 'active',
    startTime: new Date(),
    expireTime: new Date(Date.now() + order.durationHours * 3600000)
  });
  
  // 7. 更新订单状态
  await db.orders.update(order.id, {
    status: 'completed',
    transactionHash: delegateTx.txid,
    completedAt: new Date()
  });
  
  // 8. 发送通知
  await notificationService.sendOrderCompleted(order);
}
```

### 2.2 TronWeb 核心 API 使用

#### 2.2.1 质押 TRX 获取能量

```typescript
// Stake 2.0 API (TRON 新版质押)
const transaction = await tronWeb.transactionBuilder.freezeBalanceV2(
  tronWeb.toSun(amount),  // TRX 数量（转为 Sun 单位）
  'ENERGY'                // 资源类型：ENERGY 或 BANDWIDTH
);

const signedTx = await tronWeb.trx.sign(transaction);
const result = await tronWeb.trx.sendRawTransaction(signedTx);

// 返回: { result: true, txid: '...' }
```

#### 2.2.2 委托能量给其他地址

```typescript
const transaction = await tronWeb.transactionBuilder.delegateResource(
  tronWeb.toSun(balance),     // 委托的 TRX 数量
  receiverAddress,            // 接收地址
  'ENERGY',                   // 资源类型
  tronWeb.defaultAddress.base58, // 委托方地址（平台地址）
  true,                       // lock: 是否锁定
  lockPeriod                  // 锁定期（秒）: 3600 = 1小时
);

const signedTx = await tronWeb.trx.sign(transaction);
const result = await tronWeb.trx.sendRawTransaction(signedTx);
```

#### 2.2.3 查询账户能量

```typescript
const account = await tronWeb.trx.getAccount(address);

const energyInfo = {
  energyLimit: account.account_resource?.energy_limit || 0,
  energyAvailable: account.account_resource?.energy_available || 0,
  energyUsed: account.account_resource?.energy_used || 0
};
```

#### 2.2.4 解质押（到期自动或手动）

```typescript
// Stake 2.0 解质押
const transaction = await tronWeb.transactionBuilder.unfreezeBalanceV2(
  'ENERGY'  // 资源类型
);

const signedTx = await tronWeb.trx.sign(transaction);
const result = await tronWeb.trx.sendRawTransaction(signedTx);
```

---

## 3. 资源池管理策略

### 3.1 TRX 储备管理

**最小储备量**：
- 建议：100,000 TRX
- 紧急阈值：50,000 TRX
- 警告阈值：80% 利用率

**补充策略**：
```javascript
// 自动监控和告警
async function checkResourcePool() {
  const status = await resourcePoolService.getPoolStatus();
  
  if (status.availableTRX < 50000) {
    // 🚨 紧急告警
    await alertService.sendUrgentAlert('TRX 余额低于 50,000');
  } else if (status.utilizationRate > 0.8) {
    // ⚠️ 警告
    await alertService.sendWarning('资源利用率超过 80%');
  }
}
```

### 3.2 能量计算公式

```javascript
// 1 TRX 质押可获得的能量（动态变化）
const ENERGY_PER_TRX = 1200; // 保守估计

// 计算所需 TRX
function calculateRequiredTRX(energyAmount: number): number {
  return Math.ceil(energyAmount / ENERGY_PER_TRX);
}

// 示例
calculateRequiredTRX(65000);  // → 55 TRX
calculateRequiredTRX(130000); // → 109 TRX
calculateRequiredTRX(260000); // → 217 TRX
```

### 3.3 资源回收机制

```javascript
// 定时任务：每小时检查到期委托
cron.schedule('0 * * * *', async () => {
  const expiredDelegations = await db.resourceDelegations.find({
    status: 'active',
    expireTime: { $lte: new Date() }
  });
  
  for (const delegation of expiredDelegations) {
    // TRON 委托到期后自动解除，无需手动操作
    // 只需更新数据库状态
    await db.resourceDelegations.update(delegation.id, {
      status: 'expired',
      reclaimedAt: new Date()
    });
    
    logger.info(`委托 ${delegation.id} 已到期，${delegation.trxAmount} TRX 已回收`);
  }
});
```

---

## 4. 定价策略

### 4.1 成本计算

```
基础成本 = TRX 质押数量 × TRX 市场价格 × 时长系数
平台费用 = 基础成本 × 平台费率 (5%)
最终价格 = 基础成本 + 平台费用

示例：
65,000 能量，1小时
- TRX 需求：55 TRX
- TRX 市价：$0.285
- 基础成本：55 × 0.285 = $15.675
- 平台费用：15.675 × 5% = $0.784
- 最终价格：$16.459

用户支付：5.8 TRX (约 $16.5)
平台质押：55 TRX
平台利润：5.8 - 0 (质押不消耗) = 5.8 TRX
```

### 4.2 时长折扣

| 时长 | 折扣 | 说明 |
|------|------|------|
| 1小时 | 100% | 标准价格 |
| 6小时 | 95% | 5% 折扣 |
| 24小时 | 90% | 10% 折扣 |
| 3天 | 85% | 15% 折扣 |
| 7天 | 80% | 20% 折扣 |

**原因**：长时间租赁可以提高资源利用率，降低频繁操作成本。

### 4.3 会员折扣

| 等级 | 条件 | 折扣 |
|------|------|------|
| 普通用户 | 默认 | 无 |
| VIP 1 | 累计消费 1000 TRX | 5% |
| VIP 2 | 累计消费 5000 TRX | 7% |
| VIP 3 | 累计消费 10000 TRX | 10% |
| 企业用户 | 定制 | 定制 |

---

## 5. 风险管理

### 5.1 TRX 价格波动风险

**风险**：TRX 价格下跌，质押的 TRX 价值缩水

**应对**：
1. 动态定价：根据市场价格实时调整
2. 对冲策略：持有稳定币储备
3. 最低价格保护：设置价格下限

### 5.2 资源池耗尽风险

**风险**：订单量激增，TRX 储备不足

**应对**：
1. 实时监控：自动告警系统
2. 订单限流：高峰期限制接单
3. 应急储备：预留 20% 紧急 TRX

### 5.3 链上操作失败风险

**风险**：质押或委托交易失败

**应对**：
1. 交易确认：等待链上确认后再更新状态
2. 自动重试：失败后自动重试 3 次
3. 订单退款：失败订单自动退款

---

## 6. 监控指标

### 6.1 关键指标

```typescript
// 资源池健康度
interface PoolHealthMetrics {
  totalTRX: number;           // 总 TRX 数量
  frozenTRX: number;          // 已质押 TRX
  availableTRX: number;       // 可用 TRX
  utilizationRate: number;    // 利用率 (0-1)
  activeOrders: number;       // 活跃订单数
  todayRevenue: number;       // 今日收入
  todayOrders: number;        // 今日订单数
}

// 实时监控
async function getHealthMetrics(): Promise<PoolHealthMetrics> {
  const status = await resourcePoolService.getPoolStatus();
  const revenue = await calculateTodayRevenue();
  const orders = await countTodayOrders();
  
  return {
    ...status,
    todayRevenue: revenue,
    todayOrders: orders
  };
}
```

### 6.2 告警规则

| 指标 | 警告阈值 | 紧急阈值 | 操作 |
|------|---------|---------|------|
| 可用 TRX | < 20000 | < 10000 | 补充储备 |
| 利用率 | > 80% | > 90% | 限制接单 |
| 订单失败率 | > 5% | > 10% | 检查系统 |
| 响应延迟 | > 30s | > 60s | 扩容服务 |

---

## 7. 运营建议

### 7.1 初期运营

**TRX 储备**：
- 第一周：50,000 TRX
- 第一月：100,000 TRX
- 稳定期：200,000+ TRX

**定价策略**：
- 前 100 单：9 折优惠
- 新用户：首单 8 折
- 大单（>500,000 能量）：定制价格

### 7.2 扩展计划

1. **资源池扩容**：根据订单量增加 TRX 储备
2. **智能调度**：AI 预测订单高峰，提前准备资源
3. **套餐服务**：推出包月/包年套餐
4. **企业定制**：为大客户提供专属资源池

---

## 8. 常见问题 (FAQ)

### Q1: 平台需要多少 TRX 才能启动？

**A**: 建议至少 50,000 TRX 作为初始储备，可支撑约 900 单 65,000 能量的订单。

### Q2: 质押的 TRX 会消耗吗？

**A**: 不会。质押只是锁定 TRX 获取能量，到期后 TRX 自动解冻可再次使用。

### Q3: 委托到期后需要手动操作吗？

**A**: 不需要。TRON 委托到期后自动解除，能量回到平台账户。

### Q4: 如何应对 TRX 价格暴跌？

**A**: 
1. 动态调整价格
2. 持有部分稳定币对冲
3. 设置止损线

### Q5: 资源利用率多少合适？

**A**: 建议保持在 60-70%，留有足够余量应对突发订单。

---

**文档完成** ✅

这份文档详细说明了平台自主质押模式的业务流程、技术实现、风险管理和运营策略。
