# æ¶æ„è®¾è®¡æ–‡æ¡£ v2.0

## ç³»ç»Ÿæ¶æ„æ¦‚è¿°

### æ ¸å¿ƒåŸåˆ™

1. **APIè‡ªåŠ¨åŒ–** å’Œ **TGæœºå™¨äºº** ä¸¤ä¸ªç³»ç»Ÿå®Œå…¨ç‹¬ç«‹
2. è¡¨åä½¿ç”¨å•æ•°å½¢å¼
3. ä¸ä½¿ç”¨ enumï¼Œä½¿ç”¨ tinyint + å¸¸é‡å¯¹è±¡
4. æ¸…æ™°çš„æ¨¡å—èŒè´£åˆ’åˆ†
5. å…±äº«åŸºç¡€è®¾æ–½å±‚

---

## ä¸€ã€å®ä½“è®¾è®¡ï¼ˆsrc/entity/ï¼‰

### 1.1 APIå•†æˆ·ç³»ç»Ÿå®ä½“

#### merchantï¼ˆå•†æˆ·è¡¨ï¼‰

```typescript
{
  id: number PK
  name: string               // å•†æˆ·åç§°
  email: string             // é‚®ç®±
  contact_name: string      // è”ç³»äºº
  contact_phone: string     // è”ç³»ç”µè¯
  status: tinyint           // 1-æ­£å¸¸ 2-æš‚åœ 3-å°ç¦ 4-å¾…å®¡æ ¸
  level: tinyint            // 1-åŸºç¡€ç‰ˆ 2-ä¸“ä¸šç‰ˆ 3-ä¼ä¸šç‰ˆ
  api_key: string          // APIå¯†é’¥
  api_secret: string       // APIå¯†é’¥ï¼ˆåŠ å¯†ï¼‰
  ip_whitelist: json       // IPç™½åå•
  rate_limit: int          // é¢‘ç‡é™åˆ¶ï¼ˆæ¬¡/åˆ†é’Ÿï¼‰
  max_order_amount: bigint // å•ç¬”æœ€å¤§èƒ½é‡é™åˆ¶
  daily_withdraw_limit: decimal // æ¯æ—¥æç°é™é¢
  fee_rate: decimal        // æ‰‹ç»­è´¹ç‡
  callback_enabled: boolean
  callback_url: string
  total_api_calls: int
  today_api_calls: int
  last_api_call_at: timestamp
  created_at: timestamp
  updated_at: timestamp
}
```

#### merchant_orderï¼ˆå•†æˆ·è®¢å•è¡¨ï¼‰

```typescript
{
  id: number PK
  order_no: string unique   // è®¢å•å·
  merchant_id: number FK    // å•†æˆ·ID
  receiver_addr: string     // æ¥æ”¶åœ°å€
  energy_amount: bigint     // èƒ½é‡æ•°é‡
  duration_hours: int       // ç§Ÿèµæ—¶é•¿
  trx_amount: decimal       // è´¨æŠ¼TRXæ•°é‡
  price: decimal            // è®¢å•ä»·æ ¼
  unit_price: decimal       // å•ä»·
  status: tinyint          // 1-å¾…å¤„ç† 2-å¤„ç†ä¸­ 3-å·²å®Œæˆ 4-å¤±è´¥ 5-å·²å–æ¶ˆ 6-å·²è¿‡æœŸ
  type: tinyint            // 1-èƒ½é‡ç§Ÿèµ 2-è‡ªåŠ¨ç§Ÿèµ
  freeze_tx_hash: string
  delegate_tx_hash: string
  start_time: timestamp
  expire_time: timestamp
  auto_renew: boolean
  callback_url: string
  callback_sent: boolean
  fail_reason: text
  error_msg: text
  completed_at: timestamp
  created_at: timestamp
  updated_at: timestamp
}
```

#### merchant_walletï¼ˆå•†æˆ·é’±åŒ…è¡¨ï¼‰

```typescript
{
  id: number PK
  merchant_id: number FK unique
  balance: decimal          // å¯ç”¨ä½™é¢
  frozen_balance: decimal   // å†»ç»“ä½™é¢
  total_deposit: decimal    // ç´¯è®¡å……å€¼
  total_withdraw: decimal   // ç´¯è®¡æç°
  total_spent: decimal      // ç´¯è®¡æ¶ˆè´¹
  status: tinyint          // 1-æ­£å¸¸ 2-å†»ç»“ 3-å·²å…³é—­
  today_withdrawn: decimal
  last_withdraw_date: date
  last_transaction_at: timestamp
  created_at: timestamp
  updated_at: timestamp
}
```

#### merchant_withdrawalï¼ˆå•†æˆ·æç°è¡¨ï¼‰

```typescript
{
  id: number PK
  withdrawal_no: string unique
  merchant_id: number FK
  wallet_id: number FK
  amount: decimal
  address: string           // æç°åœ°å€
  fee: decimal
  actual_amount: decimal
  status: tinyint          // 1-å¾…å®¡æ ¸ 2-å·²æ‰¹å‡† 3-å¤„ç†ä¸­ 4-å·²å®Œæˆ 5-å·²æ‹’ç» 6-å¤±è´¥
  tx_hash: string
  approved_by: int
  approved_at: timestamp
  reject_reason: text
  remark: text
  created_at: timestamp
  updated_at: timestamp
}
```

#### merchant_monitorï¼ˆå•†æˆ·ç›‘æ§è¡¨ï¼‰

```typescript
{
  id: number PK
  merchant_id: number FK
  address: string           // ç›‘æ§åœ°å€
  alias: string            // åœ°å€åˆ«å
  enabled: boolean
  energy_threshold: bigint  // èƒ½é‡é˜ˆå€¼
  auto_rent_amount: bigint // è‡ªåŠ¨ç§Ÿèµæ•°é‡
  rent_duration: int       // ç§Ÿèµæ—¶é•¿ï¼ˆå°æ—¶ï¼‰
  trigger_interval: int    // è§¦å‘é—´éš”ï¼ˆåˆ†é’Ÿï¼‰
  last_triggered_at: timestamp
  trigger_count: int
  today_trigger_count: int
  max_daily_triggers: int
  last_checked_at: timestamp
  current_energy: bigint
  created_at: timestamp
  updated_at: timestamp
}
```

### 1.2 TGæœºå™¨äººç³»ç»Ÿå®ä½“

#### tg_userï¼ˆTGç”¨æˆ·è¡¨ï¼‰

```typescript
{
  id: number PK
  telegram_id: bigint unique
  telegram_username: string
  telegram_first_name: string
  telegram_last_name: string
  role: tinyint            // 1-ç®¡ç†å‘˜ 2-æ™®é€šç”¨æˆ· 3-VIPç”¨æˆ·
  status: tinyint          // 1-æ­£å¸¸ 2-æš‚åœ 3-å°ç¦
  language: string         // è¯­è¨€åå¥½
  invite_code: string
  inviter_id: int FK
  invite_count: int
  remark: text
  last_login_at: timestamp
  created_at: timestamp
  updated_at: timestamp
}
```

#### tg_walletï¼ˆTGç”¨æˆ·é’±åŒ…è¡¨ï¼‰

```typescript
{
  id: number PK
  user_id: number FK unique
  balance: decimal
  frozen_balance: decimal
  total_deposit: decimal
  total_withdraw: decimal
  total_spent: decimal
  status: tinyint
  created_at: timestamp
  updated_at: timestamp
}
```

### 1.3 å…±äº«åŸºç¡€è®¾æ–½å®ä½“

#### resource_poolï¼ˆèµ„æºæ± è¡¨ï¼‰

```typescript
{
  id: number PK
  name: string unique
  address: string          // é’±åŒ…åœ°å€
  encrypted_private_key: text
  status: tinyint          // 1-æ­£å¸¸è¿è¡Œ 2-ç»´æŠ¤ä¸­ 3-å·²åœç”¨
  total_trx: decimal
  available_trx: decimal
  balance: decimal         // é“¾ä¸Šä½™é¢
  staked_trx: decimal
  frozen_trx: decimal
  total_energy: bigint
  available_energy: bigint
  delegated_energy: bigint
  utilization_rate: decimal
  min_reserve_trx: decimal
  alert_threshold: decimal
  auto_refill: boolean
  last_sync_at: timestamp
  remark: text
  created_at: timestamp
  updated_at: timestamp
}
```

#### delegationï¼ˆå§”æ‰˜è®°å½•è¡¨ï¼‰

```typescript
{
  id: number PK
  order_id: int FK         // å…³è”è®¢å•ï¼ˆmerchant_orderï¼‰
  pool_id: int FK          // èµ„æºæ± ID
  receiver_addr: string
  owner_addr: string       // èµ„æºæ± åœ°å€
  trx_amount: decimal
  energy_amount: bigint
  lock_period: int
  status: tinyint          // 1-å§”æ‰˜ä¸­ 2-å·²åˆ°æœŸ 3-å·²å›æ”¶ 4-å·²å®Œæˆ 5-å¤±è´¥ 6-å·²å–æ¶ˆ
  freeze_tx_hash: string
  delegate_tx_hash: string
  undelegate_tx_hash: string
  unfreeze_tx_hash: string
  delegate_time: timestamp
  expire_time: timestamp
  reclaim_time: timestamp
  unfreeze_time: timestamp
  remark: text
  created_at: timestamp
  updated_at: timestamp
}
```

#### transactionï¼ˆäº¤æ˜“è®°å½•è¡¨ï¼‰

```typescript
{
  id: number PK
  tx_no: string unique
  wallet_id: int FK        // é’±åŒ…IDï¼ˆmerchant_walletæˆ–tg_walletï¼‰
  wallet_type: tinyint     // 1-å•†æˆ·é’±åŒ… 2-TGç”¨æˆ·é’±åŒ…
  type: tinyint           // 1-å……å€¼ 2-æç° 3-è®¢å•æ”¯ä»˜ 4-è®¢å•é€€æ¬¾ 5-ä½£é‡‘ 6-ç½šé‡‘ 7-è°ƒæ•´
  amount: decimal
  balance_before: decimal
  balance_after: decimal
  status: tinyint         // 1-å¾…å¤„ç† 2-å·²å®Œæˆ 3-å¤±è´¥ 4-å·²å–æ¶ˆ
  related_order_no: string
  tx_hash: string
  remark: text
  created_at: timestamp
}
```

#### operation_logï¼ˆæ“ä½œæ—¥å¿—è¡¨ï¼‰

```typescript
{
  id: number PK
  operator_id: int         // æ“ä½œäººIDï¼ˆmerchant_idæˆ–user_idï¼‰
  operator_type: tinyint   // 1-å•†æˆ· 2-TGç”¨æˆ· 3-ç³»ç»Ÿ
  action: tinyint         // æ“ä½œåŠ¨ä½œç¼–ç 
  module: string          // æ“ä½œæ¨¡å—
  description: text
  method: string
  path: string
  params: json
  success: boolean
  error_msg: text
  ip_addr: string
  user_agent: text
  duration: int
  created_at: timestamp
}
```

#### system_configï¼ˆç³»ç»Ÿé…ç½®è¡¨ï¼‰

```typescript
{
  id: number PK
  key: string unique
  value: text
  description: string
  created_at: timestamp
  updated_at: timestamp
}
```

---

## äºŒã€æ¨¡å—è®¾è®¡ï¼ˆsrc/module/ï¼‰

### 2.1 APIå•†æˆ·ç³»ç»Ÿæ¨¡å—

```
src/module/merchant-api/
â”œâ”€â”€ merchant/              # å•†æˆ·ç®¡ç†
â”‚   â”œâ”€â”€ merchant.controller.ts
â”‚   â”œâ”€â”€ merchant.service.ts
â”‚   â”œâ”€â”€ merchant.module.ts
â”‚   â””â”€â”€ dto/
â”œâ”€â”€ order/                 # è®¢å•ç®¡ç†
â”‚   â”œâ”€â”€ order.controller.ts
â”‚   â”œâ”€â”€ order.service.ts
â”‚   â”œâ”€â”€ order.module.ts
â”‚   â””â”€â”€ dto/
â”œâ”€â”€ wallet/                # é’±åŒ…ç®¡ç†
â”‚   â”œâ”€â”€ wallet.controller.ts
â”‚   â”œâ”€â”€ wallet.service.ts
â”‚   â”œâ”€â”€ wallet.module.ts
â”‚   â””â”€â”€ dto/
â”œâ”€â”€ withdrawal/            # æç°ç®¡ç†
â”‚   â”œâ”€â”€ withdrawal.controller.ts
â”‚   â”œâ”€â”€ withdrawal.service.ts
â”‚   â”œâ”€â”€ withdrawal.module.ts
â”‚   â””â”€â”€ dto/
â”œâ”€â”€ monitor/               # åœ°å€ç›‘æ§
â”‚   â”œâ”€â”€ monitor.controller.ts
â”‚   â”œâ”€â”€ monitor.service.ts
â”‚   â”œâ”€â”€ monitor.module.ts
â”‚   â””â”€â”€ dto/
â””â”€â”€ merchant-api.module.ts
```

### 2.2 TGæœºå™¨äººç³»ç»Ÿæ¨¡å—

```
src/module/telegram-bot/
â”œâ”€â”€ user/                  # TGç”¨æˆ·ç®¡ç†
â”‚   â”œâ”€â”€ user.controller.ts
â”‚   â”œâ”€â”€ user.service.ts
â”‚   â”œâ”€â”€ user.module.ts
â”‚   â””â”€â”€ dto/
â”œâ”€â”€ bot/                   # æœºå™¨äººäº¤äº’
â”‚   â”œâ”€â”€ bot.controller.ts
â”‚   â”œâ”€â”€ bot.service.ts
â”‚   â”œâ”€â”€ bot.module.ts
â”‚   â”œâ”€â”€ handlers/         # å‘½ä»¤å¤„ç†å™¨
â”‚   â”‚   â”œâ”€â”€ start.handler.ts
â”‚   â”‚   â”œâ”€â”€ balance.handler.ts
â”‚   â”‚   â”œâ”€â”€ invite.handler.ts
â”‚   â”‚   â””â”€â”€ help.handler.ts
â”‚   â””â”€â”€ keyboards/        # é”®ç›˜å¸ƒå±€
â””â”€â”€ telegram-bot.module.ts
```

### 2.3 å…±äº«åŸºç¡€æ¨¡å—

```
src/module/shared/
â”œâ”€â”€ resource/              # èµ„æºæ± ç®¡ç†
â”‚   â”œâ”€â”€ resource.service.ts
â”‚   â”œâ”€â”€ resource.module.ts
â”‚   â””â”€â”€ dto/
â”œâ”€â”€ delegation/            # å§”æ‰˜ç®¡ç†
â”‚   â”œâ”€â”€ delegation.service.ts
â”‚   â”œâ”€â”€ delegation.module.ts
â”‚   â””â”€â”€ dto/
â”œâ”€â”€ transaction/           # äº¤æ˜“ç®¡ç†
â”‚   â”œâ”€â”€ transaction.service.ts
â”‚   â”œâ”€â”€ transaction.module.ts
â”‚   â””â”€â”€ dto/
â”œâ”€â”€ tron/                  # TRONé“¾äº¤äº’
â”‚   â”œâ”€â”€ tron.service.ts
â”‚   â”œâ”€â”€ tron.module.ts
â”‚   â””â”€â”€ tron.util.ts
â””â”€â”€ shared.module.ts
```

---

## ä¸‰ã€è·¯ç”±è®¾è®¡

### 3.1 APIå•†æˆ·ç³»ç»Ÿè·¯ç”±

```
/api/v1/merchant/*          # å•†æˆ·ç®¡ç†
/api/v1/order/*             # è®¢å•ç®¡ç†
/api/v1/wallet/*            # é’±åŒ…ç®¡ç†
/api/v1/withdrawal/*        # æç°ç®¡ç†
/api/v1/monitor/*           # ç›‘æ§ç®¡ç†
```

### 3.2 TGæœºå™¨äººè·¯ç”±ï¼ˆWebhookï¼‰

```
/telegram/webhook           # TGæœºå™¨äººwebhookæ¥æ”¶
```

### 3.3 ç®¡ç†åå°è·¯ç”±

```
/admin/*                    # ç®¡ç†åå°
```

---

## å››ã€è®¤è¯è®¾è®¡

### 4.1 APIå•†æˆ·è®¤è¯

- API Key + Secret ç­¾åè®¤è¯
- IPç™½åå•éªŒè¯
- é¢‘ç‡é™åˆ¶

### 4.2 TGç”¨æˆ·è®¤è¯

- Telegram ID éªŒè¯
- ä¼šè¯ç®¡ç†

---

## äº”ã€ä¸‹ä¸€æ­¥å®æ–½è®¡åˆ’

1. âœ… åˆ é™¤æ—§ä»£ç 
2. ğŸ”„ åˆ›å»ºå®ä½“å®šä¹‰
3. ğŸ”„ åˆ›å»ºåŸºç¡€æ¨¡å—
4. ğŸ”„ å®ç°APIå•†æˆ·ç³»ç»Ÿ
5. ğŸ”„ å®ç°TGæœºå™¨äººç³»ç»Ÿ
6. ğŸ”„ é›†æˆæµ‹è¯•

---

æœ€åæ›´æ–°ï¼š2026-01-05
